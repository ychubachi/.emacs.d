;; -*- mode: Org -*-
#+STARTUP: overview indent num align inlineimages logdone hidestars
#+TAGS: TODO(t) DRAFT(d) PBLISHED(p) SOMEDAY(s)

README.org
- [[https://github.com/ychubachi/.emacs.d#readme][ychubachi/.emacs.d: emacs setting files created on 2020/11/23]]

* はじめに
** この設定について
- init.elの実行時、このREADME.orgからREADME.elを生成します。
- orgのハッケージは手動で最新版に更新しておきます。

** 事前にインストールしておくもの
- 各種フォント
  - Noto Sans Mono CJK JP-12
- migemo
  - cmigemo
- pygment
  - python3をインストール
  - /home/yc/.local/binにパス
  - pip install -U pip
  - pip install pygments
- graphviz(dot)
  - sudo apt install graphviz
- org-roam
  - sqlite3

** EmacsのX関係の設定を外部化する                                 :PBLISHED:
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-09 18:32:26]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, X resources
:ID:       o2b:93247d9c-9742-45f2-9543-eab6ffe14628
:POST_DATE: [2021-11-09 Tue 18:33]
:POSTID:   248
:END:
*** Emacs の X resources 設定
Emacs をX環境でグラフィカルに起動すると、 Emacs はXクライアントアプリケーションとなりますから、 [[https://wiki.archlinux.jp/index.php/X_resources][X resources ]]を利用した設定を読み込みます。フォントやウインドウの大きさなどを設定できます。

これらの設定は、Emacs lisp で書く init.el でもできますが、 Emacs はコンソール端末でXウインドウを使わず作業をすることも多いです。そのため、 X resources で設定できるものは、init.elではなくX resources の方に設定しておくというのも一つの考え方です。

また、 init.el  でウインドウのサイズを設定すると、一旦標準のサイズで立ち上がってから  改めて設定されたサイズに切り替わるという、ギクシャクした振る舞いになります。resources に設定しておくと、スムーズに起動します（起動時間も多少、早くなるかもしれません）。

設定できるのは、次の例の通り、Xウインドウで動作するEmacsのフォントや、行間（lineSpacing）、ウインドウのサイズ（geometry）などです。設定できる項目の一覧は [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Table-of-Resources.html][Table-of-Resources]] にあります。プログラム名は Emacs にしました[fn:1]。

#+begin_example
!! ~/.Xresources
Emacs.font: Noto Sans Mono CJK JP-12
Emacs.lineSpacing: 0
Emacs.geometry: 220x38-80+50
Emacs.cursorBlink: off
Emacs.coursorColor: dark green
Emacs.menuBar: on
Emacs.toolBar: off
Emacs.tabBar: on
Emacs.verticalScrollBars: off
Eamcs.useXIM: off
#+end_example

この設定を有効にするには、ターミナルで
#+begin_src bash
  xrdb ~/.Xresources
#+end_src

と打ちます。設定されたか確認するには、
#+begin_src bash
  xrdb -query
#+end_src

とします。この設定は logout すると無効になりますから、 Emacs を起動する前に必ず xrdb コマンドを実行しなくてはなりません。通常のXデスクトップ環境でしたら .xinitrc にこの設定をします。WSL では、 .bashrc に書いてしまって良いでしょう。

#+begin_src bash
  [[ -f ~/.Xresources ]] && xrdb ~/.Xresources
#+end_src

*** Emacsでの動作確認
.Xresources に書いた設定が読み込まれるかEmacsで試してみる方法は次のとおりです。

#+begin_src bash
  emacs -q
#+end_src

オプションは -Q でなく -q です。 -Q だと Emacs は Xリソースを処理しません[fn:2]。

[fn:1] [[https://ayatakesi.github.io/emacs/27.1/html/Resources.html][Emacsでは通常、‘emacs’です。Emacsの実行可能ファイル名の如何にかかわらずに、Emacsのすべてのインスタンスに適用される定義を指定するには、‘Emacs’を使用します。]]

[fn:2]  [[https://ayatakesi.github.io/emacs/27.1/html/Resources.html][変数inhibit-x-resourcesを非nil値にセットした場合、EmacsはXリソースを処理しません。コマンドラインオプション‘-Q’ (または‘--quick’)でEmacsを呼び出した場合、inhibit-x-resourcesは自動的にtにセットされます]]
** フォントの確認

Xウインドウで設定したフォントを確認してみましょう。本当は全て等幅になるとよいのですが、なかなか難しい・・・。

- [[https://uwabami.github.io/cc-env/Emacs.html][Emacs の設定 | Youhei SASAKI’s official site]] より
#+begin_example
| mmmm |
| llll |
| 日本 |
| 漢字 |
| ああ |
| んん |
| ￥￥ |
| \\\\ |
| 　　   |
|      |

|abcdefghijkl|
|ABCDEFGHIJKL|
|'";:-+=/\~`?|
|∞≤≥∏∑∫|
|×±≒≡⊆⊇|  ← GUI だと一部半角になる
|αβγδεζ|  ← GUI だと半角になる
|ηθικλμ|  ← GUI だと半角になる
|ΑΒΓΔΕΖ|  ← GUI だと半角になる
|ΗΘΙΚΛΜ|  ← GUI だと半角になる
|日本語の美観|
|あいうえおか|
|アイウエオカ|
|ｱｲｳｴｵｶｷｸｹｺｻｼ|

| hoge                 | hogeghoe | age              |
|----------------------+----------+------------------|
| 今日もいい天気ですね | お、     | 等幅になった👍 🍺|
|----------------------+----------+------------------|
#+end_example

** Copyright
- Copyright など。

#+begin_src emacs-lisp
  ;;; README.el --- My README.el  -*- lexical-binding: t; -*-

  ;; Copyright (C) 2020 Yoshihide Chubachi

  ;; Author: Yoshihide Chubachi <yoshi@chubachi.net>

  ;; This program is free software: you can redistribute it and/or modify
  ;; it under the terms of the GNU General Public License as published by
  ;; the Free Software Foundation, either version 3 of the License, or
  ;; (at your option) any later version.

  ;; This program is distributed in the hope that it will be useful,
  ;; but WITHOUT ANY WARRANTY; without even the implied warranty of
  ;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  ;; GNU General Public License for more details.

  ;; You should have received a copy of the GNU General Public License
  ;; along with this program.  If not, see <http://www.gnu.org/licenses/>.

  ;;; Commentary:

  ;;  My README.el.

  ;;; Code:
#+end_src

* パッケージ管理
** leaf - 「パッケージ設定」のためのパッケージ                    :PBLISHED:
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-10 00:01:40]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, Lisp, Leaf
:ID:       o2b:046ef621-cfc9-4aa5-9704-861b7710b61d
:POST_DATE: [2021-11-10 Wed 00:03]
:POSTID:   293
:END:

*** leafの設定
leafはEmacsの設定をより美しく記述できるようにする、パッケージの設定を記述するツールです。パッケージのインストールための様々なパッケージと組み合わせ利用します。設計思想がしっかりしていて、利用者を惑わせない、特に、Emacs lispを解する人にとっては、lispの世界観を崩さないで記述できるのが魅力でしょう。

はじめに、leafに関する全ての設定を紹介します。次に、部分ごとに設定を説明します。

#+CAPTION: leafの設定（全体）
#+NAME: leaf
#+begin_src emacs-lisp :noweb yes
  (prog1 "prepare leaf"
    <<setup-package>>

    <<install-leaf>>

    <<install-leaf-optional-packages>>)
#+end_src

#+RESULTS: leaf
: prepare leaf

*** パッケージ機能の初期設定
最初に、パッケージを取ってくる場所（＝リポジトリ）を設定します。melpaとgnuの2つを使うようにしています。

Emacsのバージョンを29.0.50にしたのでorgのリポジトリは削除しました（追加する場合は ~("org"   . "https://orgmode.org/elpa/")~ を記入）。

設定が終わったらイニシャライズします。

#+NAME: setup-package
#+begin_src emacs-lisp :tangle no
  (prog1 "package"
    (custom-set-variables
     '(package-archives
       '(("melpa" . "https://melpa.org/packages/")
         ("gnu"   . "https://elpa.gnu.org/packages/"))))
    (package-initialize))
#+end_src

#+RESULTS: setup-package
: package

*** leaf本体のインストール
Emacs標準のパッケージ機能を使って、leafそのものをインストールします。
#+NAME: install-leaf
#+begin_src emacs-lisp :tangle no
  (prog1 "leaf"
    (unless (package-installed-p 'leaf)
      (unless (assoc 'leaf package-archive-contents)
        (package-refresh-contents))
      (condition-case err
          (package-install 'leaf)
        (error
         (package-refresh-contents)
         (package-install 'leaf)))))
#+end_src

#+RESULTS: install-leaf
: leaf

*** leafに関連するパッケージ
leafに追加するパッケージです。

#+NAME: install-leaf-optional-packages
#+begin_src emacs-lisp :tangle no
  (leaf leaf
    :config
    (leaf leaf-keywords
      :ensure t
      :config (leaf-keywords-init))
    (leaf leaf-convert
      :ensure t)
    (leaf leaf-tree
      :ensure t
      :custom ((imenu-list-size . 30)
               (imenu-list-position . 'left)))
    (leaf hydra
      :ensure t)
    (leaf el-get
      :ensure t
      :custom ((el-get-git-shallow-clone  . t)))
    (leaf diminish
      :ensure t))
#+end_src

#+RESULTS: install-leaf-optional-packages
: leaf

*** 参考
+ [[https://qiita.com/conao3/items/dc88bdadb0523ef95878#%E3%83%80%E3%82%A6%E3%83%B3%E3%83%AD%E3%83%BC%E3%83%89%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB][[正式リリース]leaf.elで雑然としたEmacs設定ファイル「init.el」をクリーンにする - Qiita]]
+ [[https://qiita.com/conao3/items/347d7e472afd0c58fbd7#%E4%BE%BF%E5%88%A9%E3%83%91%E3%83%83%E3%82%B1%E3%83%BC%E3%82%B8%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB][Emacs入門から始めるleaf.el入門 - Qiita]]
+ leaf-hydraは[[https://github.com/abo-abo/hydra][hydra]]でキーの設定を行う際に使用します。
+ [[https://qiita.com/tadsan/items/c859c5c04724cbda75fc][指定したマイナーモードを表示しない(diminish篇) - Qiita]]

** パッケージ管理（straight）

#+begin_src emacs-lisp
  (leaf straight
    :config
    (defvar bootstrap-version)
    (let ((bootstrap-file
           (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
          (bootstrap-version 5))
      (unless (file-exists-p bootstrap-file)
        (with-current-buffer
            (url-retrieve-synchronously
             "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
             'silent 'inhibit-cookies)
          (goto-char (point-max))
          (eval-print-last-sexp)))
      (load bootstrap-file nil 'nomessage))
    (setq package-enable-at-startup nil))
#+end_src

#+RESULTS:
: straight

* カスタマイズ変数
** カスタマイズファイルを分離（cus-edit）

#+begin_src emacs-lisp
  (leaf cus-edit
    :doc "tools for customizing Emacs and Lisp packages"
    :tag "builtin" "faces" "help"
    :custom `((custom-file . ,(locate-user-emacs-file "custom.el"))))
#+end_src

#+RESULTS:
: cus-edit

** customize変数の設定（cus-start）
- 一旦全て設定せず、必要になったら再度設定する
- グローバルモードの設定がカスタマイズ変数でもできる場合、カスタマイズ変数を使用

#+begin_src emacs-lisp
  (leaf cus-start
    :doc "define customization properties of builtins"
    :tag "builtin" "internal"
    :custom
    ((inhibit-startup-screen . t)               ; スタートアップスクリーンを非表示
     (ring-bell-function . 'ignore)             ; ベルを鳴らさない
     (fill-column . 100))                       ; 100桁で改行（モードによる）
    :custom
    ((global-display-line-numbers-mode . t)     ; 行番号表示
     (display-line-numbers-width . 4))          ; 表示する行番号の桁数
    :custom
    ((global-auto-revert-mode . t)              ; 更新されたら自動的に再読込
     (auto-revert-verbose . nil))                       ; 再読込の際、メッセージを非表示
    :custom
    ((show-paren-mode . t)                      ; 括弧の対応関係を表示する
     (show-paren-style . 'mixed))                       ; 対応関係を表示するスタイル
    :custom                                     ; VCの設定
    ((vc-follow-symlinks . t)                   ; VC対象ファイルのシンボリックリンクの場合、本体を辿る
     (auto-revert-check-vc-info . t))           ; VCで更新があった場合、自動で更新
    :custom                                     ; 最後に編集した場所を記憶
    ((save-place-mode . t))
    :custom                                     ; バックアップファイルの設定
    ((version-control . t)
     (backup-directory-alist . '(("." . ".~")))
     (delete-old-versions . t)))
#+end_src

#+RESULTS:
: cus-start

+ 参考
  * [[https://ayatakesi.github.io/emacs/24.5/Backup-Names.html][GNU Emacs Manual(Japanese Translation): Backup Names]]
  * If delete-old-versions is t, Emacs deletes the excess backup files silently.]]

+ 古い設定
#+begin_src emacs-lisp :tangle no
  (leaf cus-start
    :doc "define customization properties of builtins"
    :tag "builtin" "internal"
    :preface
    (defun c/redraw-frame nil
      (interactive)
      (redraw-frame))
    :bind (("M-ESC ESC" . c/redraw-frame))
    :custom '((user-login-name . "yc")
              (create-lockfiles . nil)
              (debug-on-error . t)
              (init-file-debug . t)
              (frame-resize-pixelwise . t)
              (enable-recursive-minibuffers . t)
              (history-length . 1000)
              (history-delete-duplicates . t)
              (scroll-preserve-screen-position . t)
              (scroll-conservatively . 100)
              (mouse-wheel-scroll-amount . '(1 ((control) . 5)))
              (text-quoting-style . 'straight)
              (use-dialog-box . nil)
              (use-file-dialog . nil)
              (indent-tabs-mode . nil)
              ))
#+end_src

#+RESULTS:
: cus-start

* Emacs本体の設定
** (require 'cl)を検査しない

#+begin_src emacs-lisp
  (leaf *emacs
    :config
    (setq byte-compile-warnings '(not cl-functions obsolete)))
#+end_src

#+RESULTS:
: *emacs

** yes/noの選択をy/nに簡略化

#+begin_src emacs-lisp
  (defalias 'yes-or-no-p 'y-or-n-p)
#+end_src

#+RESULTS:
: yes-or-no-p

** 保存時、不要な空白を削除

#+begin_src emacs-lisp
  (add-hook 'before-save-hook 'delete-trailing-whitespace)
#+end_src

#+RESULTS:
| delete-trailing-whitespace |

* キーバインディング
** C-hをBSに、C-@をhelpに
- 標準で
- [[https://www.reddit.com/r/spacemacs/comments/l2fjzy/remapping_ch_to_backspace_and_remap_help_menu_to/][Remapping C-h to backspace, and remap "help" menu to anything else? : spacemacs]]

- :init ではなく :config だと機能しない
  - :config の中身は eval-after-load で実行される
  - :bindがあるとこうなるようだ
- help-map は :bind で設定できない
  - ここでは :bind を利用しない
  - :bind を利用しなければ :init と :config

#+begin_comment
    (global-set-key (kbd "C-h") 'delete-backward-char))
    (global-set-key (kbd "C-@") help-map)
#+end_comment

#+begin_src emacs-lisp
  (leaf *backspace
    :init (global-set-key (kbd "C-@") help-map)
    :bind (("C-h" . delete-backward-char)))
#+end_src

#+RESULTS:
: *backspace

** UndoをC-zに
- 指が覚えてしまっている

#+begin_src emacs-lisp
  (leaf *undo :bind (("C-z" . undo)))
#+end_src

#+RESULTS:
: *undo

** toggle-truncate-linesをC-c tに

#+begin_src emacs-lisp
  (leaf *toggle-truncate-lines :bind (("C-c t" . toggle-truncate-lines)))
#+end_src

#+RESULTS:
: *toggle-truncate-lines

* ビルトインパッケージの設定
** isearch

- isearch で漢字入力ができるようにする

#+begin_src emacs-lisp
  (leaf isearch
    :bind ((isearch-mode-map
            ("C-o" . isearch-toggle-input-method))))
#+end_src

** wdired

- [[https://ohzeki.hatenablog.com/entry/20160115/1452838970][Emacsのdired表示でファイル名編集 - ohzeki’s diary]]

#+begin_src emacs-lisp
  (leaf wdired
    :doc "Rename files editing their names in dired buffers"
    :tag "builtin"
    :added "2020-11-21"
    :require t
    :config
    (define-key dired-mode-map "r" 'wdired-change-to-wdired-mode)
    :bind ((wdired-mode-map
            ("C-o" . toggle-input-method))))
#+end_src

#+RESULTS:
: wdired

** macrostep

- elispのマクロを展開する

#+begin_src emacs-lisp
  (leaf macrostep
    :doc "interactive macro expander"
    :req "cl-lib-0.5"
    :tag "debugging" "macro" "languages" "lisp"
    :url "https://github.com/joddie/macrostep"
    :package t
    :bind (("C-c e" . macrostep-expand)))
#+end_src

#+RESULTS:
: macrostep

** recentf
- recentf-modeはカスタマイズ変数にできる

#+begin_src emacs-lisp
  (leaf recentf
    :custom
    (recentf-max-saved-items . 2000)
    (recentf-auto-cleanup quote never)
    (recentf-exclude quote
                     ("/recentf" "COMMIT_EDITMSG" "/.?TAGS" "^/sudo:"))
    :config
    (setq recentf-auto-save-timer
          (run-with-idle-timer 30 t (lambda () (let ((save-silently t)) (recentf-save-list)))))
    (recentf-mode 1))
#+end_src

#+RESULTS:
: recentf

** midnight - 一定期間使用しなかった buffer を自動削除
- 使い方、これでいいのかな？
- [[https://uwabami.github.io/cc-env/Emacs.html][midnight: 一定期間使用しなかった buffer を自動削除]]

#+begin_src emacs-lisp
  (leaf midnight
    :custom
    ((clean-buffer-list-delay-general . 1))
    :hook
    (emacs-startup-hook . midnight-mode))
#+end_src

#+RESULTS:
: midnight

** which-key - キーバインドのガイド表示                              :draft:
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-10 23:59:23]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, Lisp
:ID:       o2b:f8c43d20-c1e2-4009-961f-48178cde8c6b
:POST_DATE: [2021-11-11 Thu 00:23]
:POSTID:   344
:END:

Emacsでは、コントロールやAltキーを押しながら一文字打って、更にもう一文字打つとコマンドが実行される、という操作が基本です。

このキー操作の組み合わせ、慣れれば手が覚えて、自然に操作できるようになるものです。しかしながら、覚えるまでは大変です。特に初心者にとってはいちいち調べるのもやっかいです。

which-keyパッケージはこの負担を幾分、軽減してくれます。例えば、ファイルを保存するコマンドはC-x C-sです。ですがこれを忘れて、「ファイルを保存するときはC-xを打ってから、何を打つんだっけ？」といったとき、このパッケージが有効です。

C-xを打って入力をやめると、画面にその先に打つ文字とそれに対応したコマンドのリストを表示してくれます。

とても便利！・・・と言いたいところですが、結局はメニューに出てくるコマンドの数そのものが多いので、一覧の中から目的のものを見つけるのも一苦労であったりします。もちろん、選択肢が少ない場合は大助かりです。

なかなかEmacsのキー操作が覚えられないよ、という場合は試してみてください。

#+begin_src emacs-lisp
  (leaf which-key
    :doc "Display available keybindings in popup"
    :req "emacs-24.4"
    :tag "emacs>=24.4"
    :url "https://github.com/justbur/emacs-which-key"
    :added "2021-10-20"
    :emacs>= 24.4
    :ensure t
    :config
    (which-key-mode))
#+end_src

#+RESULTS:
: which-key

** imenu-list

#+begin_src emacs-lisp
  (leaf *imenu-list
    :bind (("C-^" . imenu-list-smart-toggle)))
#+end_src

#+RESULTS:
: *imenu-list

** align - コメントの位置を揃えたりする

#+begin_src emacs-lisp
  (leaf align
    :doc "align text to a specific column, by regexp"
    :tag "builtin"
    :added "2021-10-30"
    :bind (("C-c M-a" . align-regexp))
    )
#+end_src

#+RESULTS:
: align

** outline-minnor-mode - アウトラインマイナーモードの設定
+ outline-modeのプリフィックスはC-c C-oに変更しました。理由は指が慣れていること。org-open-at-pointとバッティングしますが、そもそもoutline-minnor-modeとorg-modeを併用することはないので気にしないことにしています。

#+begin_src emacs-lisp
  (leaf outline-minor-mode
    :config
    (add-hook 'outline-minor-mode-hook
              (lambda () (local-set-key "\C-c\C-o"
                                        outline-mode-prefix-map))))
#+end_src

#+RESULTS:
: outline-minor-mode

* ミニバッファ補完UI関連の設定
** vertico:本体の設定

- [[https://github.com/minad/vertico/][GitHub - minad/vertico: vertico.el - VERTical Interactive COmpletion]]

#+begin_src emacs-lisp
  (leaf vertico
    :straight t
    :custom
    ;; 最大20件まで表示するように
    (vertico-count . 20)
    :config
    (vertico-mode)
    (setq vertico-resize t)
    (setq vertico-cycle t)
    )
#+end_src

#+RESULTS:
: vertico

** orderless
- [[https://github.com/oantolin/orderless][GitHub - oantolin/orderless: Emacs completion style that matches multiple regexps in any order]]

#+begin_src emacs-lisp
  (leaf orderless
    :straight t
    :init
    ;; Configure a custom style dispatcher (see the Consult wiki)
    ;; (setq orderless-style-dispatchers '(+orderless-dispatch))
    (setq completion-styles '(orderless)
          completion-category-defaults nil
          completion-category-overrides '((file (styles partial-completion)))))
#+end_src

#+RESULTS:
: orderless

** savehist

#+begin_src emacs-lisp
  ;; Persist history over Emacs restarts. Vertico sorts by history position.
  (leaf savehist
    :straight t
    :init
    (savehist-mode))
#+end_src

#+RESULTS:
: savehist

** Marginalia
- [[https://github.com/minad/marginalia][GitHub - minad/marginalia: marginalia.el - Marginalia in the minibuffer]]
- Enable richer annotations using the Marginalia package

#+begin_src emacs-lisp
  (leaf marginalia
    :straight t
    :bind (:minibuffer-local-map
           ("M-A" . marginalia-cycle))
    :init
    (marginalia-mode))
#+end_src

#+RESULTS:
: marginalia

** embark - カーソル位置にあるテキストに対するアクションを実行（org link対応） :PBLISHED:
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-20 19:03:55]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, Lisp, embark
:ID:       o2b:ee0b1a39-a8d8-494b-9e7d-02d794982f19
:POST_DATE: [2021-11-20 Sat 19:03]
:POSTID:   363
:END:

*** 「何か」に対して何かを「実行」するembark
テキストファイルに書いてあるURLを開きたい、と思ったとき、あなたはどうしますか？

今どきのテキストエディタはURLやメールアドレスなどを認識し、リンクとして表示してくれますね。このリンクを開くには、リンクにマウスカーソルをあて、クリックするのが普通です。

Emacsでもモードによっては同じように動作します（orgモードなど）。この際、マウスではなくてキーボードでも開くことができます。orgモードですと、テキストカーソルをリンクの上に移動させ、C-c C-oで開けます。org-open-at-pointという関数が呼び出されます。リンクはURLやメールアドレスだけでなく、他のorgファイルへの参照や、脚注があります。

さて、話をより一般的にして「いまカーソルの位置にある何か」に対して「アクション」を行うことをできるようにする、embark[fn:embark]というパッケージがあります。「URLを開く」というアクションだけでなく、ソースコードのシンボルの定義を開く、ヘルプを調べるなど様々なアクションを実行できます。

何かをしたい（ex URLを開く、シンボルの定義を参照する、等）文字列があればそこにカーソルをもっていき、embark-act（私はM-.に設定）を実行しましょう。そうすれば、ミニバッファにメニューが表示され、実行したいアクションを選択できます。

また、 embark-dwim （C-.に設定）を押すとembarkがおすすめのアクションを選んで実行してくれます。なお、dwimとはdo what i meanの略で、「私の意図するところを（察して）行え」といった意味でしょうか。意訳すれば、「適当によろしく」みたいなものかな。

*** org linkを辿るアクションが見当たらない!
さて、この便利なembark、とても不思議なことに、orgのリンクを扱うアクションが見当たりませんでした。結構、いろいろ検索して見当たらなかったので、「ない理由が分からない自分のほうが変なのかも」とも思った次第です。

まあ、とはいえ、あってもだれも困らないとも思うので、自分で作りました。orgモードと、もちろん、embarkに依存するので、leafで設定をしています。

#+NAME: my-embark-orglink
#+begin_src emacs-lisp :syntaxhl :tangle no
  (leaf *my-embark-orglink
    :after org embark
    :config
    (defun my-embark-orglink-at-point ()
      "Target a link at point of orglink."
      (save-excursion
        (let* ((cur (point))
               (beg (progn (search-backward "[" nil t) (point)))
               (end (progn (search-forward  "]" nil t) (point)))
               (str (buffer-substring-no-properties beg end)))
          (when (and (<= beg cur) (<= cur end))
            (save-match-data
              (when (string-match "\\(\\[.+\\]\\)" str)
                `(orglink
                  ,(format "%s" (match-string 1 str))
                  ,beg . ,end)))))))
    (add-to-list 'embark-target-finders 'my-embark-orglink-at-point)
    (embark-define-keymap embark-orglink-map
      "Orglink keymap"
      ("RET" org-open-at-point)
      ("o" org-open-at-point))
    (add-to-list 'embark-keymap-alist '(orglink . embark-orglink-map)))
#+end_src

#+RESULTS: my-embark-orglink
: *my-embark-orglink

*** 全体の設定
せっかくですので、設定全体も掲載しておきますね。バインディングに使っているC-@ですがヘルプのプレフィックスです。私はC-hをBSにしているので、C-@をヘルプ（もともとのC-hの機能）にしています。

#+begin_src emacs-lisp :syntaxhl :noweb yes
  (leaf embark
    :straight t
    :bind
    (("M-." . embark-act)
     ("C-." . embark-dwim)
     ("C-@ B" . embark-bindings) ;; C-h -> C-@ にしています
     )
    :init
    (setq prefix-help-command #'embark-prefix-help-command)
    :config
    (add-to-list 'display-buffer-alist
                 '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                   nil
                   (window-parameters (mode-line-format . none))))
    :config
    <<my-embark-orglink>>)
#+end_src

#+RESULTS:
: embark

*** 閑話休題
探せばどこかに必ずあるはずだ、と思って探したものがどうしても見つからないとき、「あるはずだ」と思った自分が間違っているのではないか、とも思ってしまうのは、自分の弱さなのでしょうか。

ところで、embarkとは「Emacs Mini-Buffer Actions Rooted in Keymaps」の頭文字を取って名付けたようです。キーマップに基づきミニバッファで行うアクションといった意味になりますが、もともと embark は英語で「乗船する」という単語です。なかなかおしゃれなネーミングなのですね。

[fn:embark] [[https://github.com/oantolin/embark][GitHub - oantolin/embark: Emacs Mini-Buffer Actions Rooted in Keymaps]]

*** COMMENT 備考
- 関係ないけど正規表現を試すには
  - [[https://koseki.hatenablog.com/entry/20110710/emacsReBuilder][Emacsの正規表現編集モード re-builder とややこしいバックスラッシュ問題について。 - こせきの技術日記]]

- 本当はorgをロードしたら実行すべき
(org-thing-at-point)が使えない？nilを返してくる

- emberkのアクションはキーマップで定義
  - embark-url-map
  - embark-general-map

** consult
- [[https://github.com/minad/consult][GitHub - minad/consult: consult.el - Consulting completing-read]]

#+begin_src emacs-lisp
  ;; Example configuration for Consult
  (leaf consult
    :straight t
    ;; Replace bindings. Lazily loaded due by `use-package'.
    :bind (;; C-c bindings (mode-specific-map)
           ("C-c h" . consult-history)
           ("C-c m" . consult-mode-command)
           ;; ("C-c b" . consult-bookmark)
           ("C-c k" . consult-kmacro)
           ;; ("C-c r" . consult-recent-file)
           ;; C-x bindings (ctl-x-map)
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ("<help> a" . consult-apropos)            ;; orig. apropos-command
           ;; M-g bindings (goto-map)
           ("M-g e" . consult-compile-error)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings (search-map)
           ("M-s f" . consult-find)
           ("M-s F" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s m" . consult-multi-occur)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch)
           (:isearch-mode-map
            ("M-e" . consult-isearch)                 ;; orig. isearch-edit-string
            ("M-s e" . consult-isearch)               ;; orig. isearch-edit-string
            ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
            ("M-s L" . consult-line-multi)))           ;; needed by consult-line to detect isearch

    ;; Enable automatic preview at point in the *Completions* buffer.
    ;; This is relevant when you use the default completion UI,
    ;; and not necessary for Vertico, Selectrum, etc.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Optionally configure the register formatting. This improves the register
    ;; preview for `consult-register', `consult-register-load',
    ;; `consult-register-store' and the Emacs built-ins.
    (setq register-preview-delay 0
          register-preview-function #'consult-register-format)

    ;; Optionally tweak the register preview window.
    ;; This adds thin lines, sorting and hides the mode line of the window.
    (advice-add #'register-preview :override #'consult-register-window)

    ;; Optionally replace `completing-read-multiple' with an enhanced version.
    (advice-add #'completing-read-multiple :override #'consult-completing-read-multiple)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key (kbd "M-."))
    ;; (setq consult-preview-key (list (kbd "<S-down>") (kbd "<S-up>")))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme
     :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-file consult--source-project-file consult--source-bookmark
     :preview-key (kbd "M-."))

    ;; Optionally configure the narrowing key.
    ;; Both < and C-+ work reasonably well.
    (setq consult-narrow-key "<") ;; (kbd "C-+")

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help)

    ;; Optionally configure a function which returns the project root directory.
    ;; There are multiple reasonable alternatives to chose from.
    ;;;; 1. project.el (project-roots)
    (setq consult-project-root-function
          (lambda ()
            (when-let (project (project-current))
              (car (project-roots project)))))
    ;;;; 2. projectile.el (projectile-project-root)
    ;; (autoload 'projectile-project-root "projectile")
    ;; (setq consult-project-root-function #'projectile-project-root)
    ;;;; 3. vc.el (vc-root-dir)
    ;; (setq consult-project-root-function #'vc-root-dir)
    ;;;; 4. locate-dominating-file
    ;; (setq consult-project-root-function (lambda () (locate-dominating-file "." ".git")))
    )
#+end_src

#+RESULTS:
: consult

** embark-consult

#+begin_src emacs-lisp
  ;; Consult users will also want the embark-consult package.
  (leaf embark-consult
    :straight t
    :after (embark consult)
    ;; :demand t ; only necessary if you have the hook below
    ;; if you want to have consult previews as you move around an
    ;; auto-updating embark collect buffer
    :hook
    (embark-collect-mode . consult-preview-at-point-mode)
    )
#+end_src

#+RESULTS:
: embark-consult

* org-mode関連の設定
** orgのためのディレクトリ設定
- org-agenda-filesのリストにDropboxのディレクトリを追加しておく。
  - この中にあるorgファイルがすべてagendaに反映される。
- org-num-modeをすべてのファイルで実行する
  - (org-startup-numerated . t)がうまく反映されない。
- Androd端末から利用するには [[https://play.google.com/store/apps/details?id=com.orgzly][Orgzly]] が良さそう。

- 設定するアジェンダファイル

  | ファイル          | 内容                           |
  |-------------------+--------------------------------|
  | Journal.org       | 思いつき、メモを書きなぐり用   |
  | Notebook.org      | ある程度きちんとしたメモ書き   |
  | ブログファイル    | ブログの記事をまとめたファイル |
  | emacs設定ファイル | orgファイルで書いたEmacsの設定 |

  - TODOはどのファイルに書いて良い
  - org-switchbかconsult-org-agendaをどこかにバインドするといいかも？（C-,）
    - C-c bにバインド
** org-modeの設定

+ TODOをMAYBE NEXT STARED WAITING DLEGATEDなど分けてもよいが、TODOに優先度#A #B #Cをつけるほうがアジェンダが見やすくなる

+ 見出しを折りたたんだときの...を変更
  * [[https://endlessparentheses.com/changing-the-org-mode-ellipsis.html][Changing the org-mode ellipsis · Endless Parentheses]]

#+begin_src emacs-lisp
  (leaf org-mode
    :bind
    (("C-c l" . org-store-link)
     ("C-c a" . org-agenda)
     ("C-c c" . org-capture)
     ("C-c j" . (lambda () (interactive) (org-capture nil "j"))))
    :hook (org-mode-hook . visual-fill-column-mode)
    :custom
    (org-directory . "~/Dropbox/Org/")
    (org-default-notes-file . "~/Dropbox/Org/Notebook.org")
    (org-agenda-files . '("~/Dropbox/Org/"
                          "~/git/ploversky-zenn.dev/plaversky@zenn.dev.org"
                          "~/git/ploversky-ploversky.net/plaversky.net.org"
                          "~/.emacs.d/README.org"
                          "~/Dropbox/Org/gcal/"
                          ))
    (org-todo-keyword-faces
     . '(("NEXT" . (:foreground "blue" :underline t))
         ("DONE" . (:foreground "pale green"))))
    (org-todo-keywords . '((sequence "TODO" "NEXT" "|" "DONE" "SOMEDAY")))
    (org-refile-targets . '((org-agenda-files :tag . "REFILE")))
    (org-startup-truncated . nil)
    (org-return-follows-link  . t) ; RET/C-mでリンクを開く
    (org-agenda-start-with-follow-mode . t) ; アジェンダで関連するorgファイルを開く
    (org-ellipsis . " ▽") ; …,▼, ↴, ⬎, ⤷, ⋱
    )
#+end_src

#+RESULTS:
: org-mode

** doctを利用したorg-captureの設定

- [[https://orgmode.org/manual/Capture-templates.html][Capture templates (The Org Manual)]]
- [[https://www.5ing-myway.com/org-capture/][org-captureをカスタマイズして、すばやくメモを取る方法 | 趣味に生きる。]]

- ファイルは org-directory 以下にある。

- [[https://github.com/progfolio/doct#installation][GitHub - progfolio/doct: DOCT: Declarative Org Capture Templates for Emacs]]
- ミニバッファで日本語が入力できない
- [[https://blog.tomoya.dev/posts/a-new-wave-has-arrived-at-emacs/][Emacsの次世代ミニバッファ補完UI | 日々、とんは語る。]]

#+begin_src emacs-lisp
  (leaf doct
    :ensure t
    ;;recommended: defer until calling doct
                                          ;:commands (doct)
    :config
    (setq org-capture-templates
          (doct '(("Journal" :keys "j"
                   :empty-lines-after 1
                   :file "~/Dropbox/Org/Journal.org"
                   :datetree t
                   :todo-state "TODO"
                   :template ("* %{todo-state} %?"
                              ":PROPERTIES:"
                              ":CREATED: %U"
                              ":ANNOTADED: %a"
                              ":END:"))
                  ("Notebook" :keys "n"
                   :prepend t
                   :empty-lines-after 1
                   :file "~/Dropbox/Org/Notebook.org"
                   :unnarrowed t
                   :template ("* %^{Description}"
                              ":PROPERTIES:"
                              ":CREATED: %T"
                              ":END:"
                              "\n%?"))
                  ("Blog" :keys "b"
                   :prepend t
                   :empty-lines-after 1
                   :unnarrowed t
                   :children
                   (("ploversky@zenn.dev" :keys "z"
                     :file "~/git/ploversky-zenn.dev/plaversky@zenn.dev.org"
                     :headline   "記事"
                     :todo-state "TODO"
                     :export_file_name (lambda () (concat (format-time-string "%Y%m%d-%H%M%S")))
                     :template ("* %{todo-state} %^{Description}"
                                ":PROPERTIES:"
                                ":CREATED: %T"
                                ":EXPORT_FILE_NAME: articles/%{export_file_name}"
                                ":EXPORT_GFM_TAGS: blog"
                                ":EXPORT_GFM_CUSTOM_FRONT_MATTER: :emoji 👩‍💻"
                                ":EXPORT_GFM_CUSTOM_FRONT_MATTER+: :type tech"
                                ":EXPORT_GFM_CUSTOM_FRONT_MATTER+: :published false"
                                ":END:"
                                "\n** %?"))
                    ("ploversky.net" :keys "w"
                     :file "~/git/ploversky-ploversky.net/plaversky.net.org"
                     :headline   "Blog"
                     :todo-state "TODO"
                     :template ("* %{todo-state} %^{Description}"
                                ":PROPERTIES:"
                                ":CREATED: %T"
                                ":CATEGORY: Blog"
                                ":POST_TAGS: Blog"
                                ":BLOG:     plover"
                                ":END:"
                                "\n** %?"))
                    ("blog.chubachi.net"  :keys "b"
                     :file "~/git/ychubachi.github.io/blog.chubachi.net.org"
                     :headline   "Blog"
                     :todo-state "TODO"
                     :export_file_name (lambda () (concat (format-time-string "%Y%m%d-%H%M%S")))
                     :template ("* %{todo-state} %^{Description}"
                                ":PROPERTIES:"
                                ":CREATED: %T"
                                ":EXPORT_FILE_NAME: %{export_file_name}"
                                ":EXPORT_DATE: %U"
                                ":END:"
                                "\n** %?"))
                    )
                   )
                  )
                )
          )
    )
#+end_src

#+RESULTS:
: doct

** org-tempo - ソースコードブロック入力の省力化
   - "<el"+<TAB> 等でemacs-lispのソースコードブロックがでるように設定。

#+begin_src emacs-lisp
  (leaf org-tempo
    :require t
    :config
    (add-to-list 'org-structure-template-alist
                 '("el" . "src emacs-lisp"))
    (add-to-list 'org-structure-template-alist
                 '("bash" . "src bash"))
    )
#+end_src

#+RESULTS:
: org-tempo

** latex関連
*** orgでlatexの設定例
    - 表題・筆者・日付の書き方

    #+begin_comment
    #+TITLE: とても素晴らしい研究の発表
    #+AUTHOR: 中鉢 欣秀, CHUBACHI Yoshihide
    #+DATE: 2021-08-06
    #+end_comment

    - 目次を出力しない

    #+begin_comment
    #+OPTIONS: toc:nil # hoge
    #+end_comment

    - 参考
      - [[https://www-he.scphys.kyoto-u.ac.jp/member/shotakaha/dokuwiki/doku.php?id=toolbox:emacs:org:latex:start][Org-LaTeX [QumaWiki]]]
      - [[https://taipapamotohus.com/post/org-mode_paper_3/][Emacsのorg-modeで論文を書く（その3：org-modeとbibtexとreftexの連携による文献引用の自動化） | A perfect autumn day]]

    #+begin_comment
#+LaTeX_CLASS: koma-jarticle
#+LaTeX_CLASS_OPTIONS: [12pt]
#+LATEX_HEADER: \usepackage{geometry}
#+LATEX_HEADER: \geometry{left=1in,right=1in,top=1in,bottom=1in}
#+LaTeX_HEADER: \usepackage[sort,compress,super,comma]{natbib}
#+STARTUP:  overview
#+STARTUP:  hidestars
#+OPTIONS:   H:4 num:nil toc:nil \n:nil @:t ::t |:t ^:t -:t f:t *:t TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+OPTIONS: date:nil
      #+end_comment

*** latex本体
- [[https://texwiki.texjp.org/?Emacs%2FOrg%20mode#h20d131a][Emacs/Org mode - TeX Wiki]]
  - org-latex-pdf-process は記載の通りだと%S等をorg側で置換しようとしてエラー
- latexmkの設定は~/.latexmkrcに記述
  - [[https://texwiki.texjp.org/?Latexmk#g2a2cf08][Latexmk - TeX Wiki]]
  - latexmkの相性のせいか、org-export-in-backgroundをtにするとエラー
- LaTeXの文字列部分は別ファイルにするのがよいかもしれない
  - [[http://ergoemacs.org/emacs/elisp_read_file_content.html][Elisp: Read File Content as String or List of Lines]]

#+begin_src emacs-lisp
  (leaf ox-latex
    :require t
    :setq ((org-latex-default-class . "bxjsarticle")
           (org-latex-pdf-process . '("latexmk -gg -pdfdvi -pvc- %f")))
    :config
    (add-to-list
     'org-latex-classes
     '("bxjsarticle"
       "% begin org-latex-class bxjsarticle
    \\documentclass[autodetect-engine,dvi=dvipdfmx,11pt,a4paper,ja=standard]{bxjsarticle}
    [NO-DEFAULT-PACKAGES]
    \\usepackage{amsmath}
    \\usepackage{newtxtext,newtxmath}
    \\usepackage{graphicx}
    \\usepackage{hyperref}
    \\ifdefined\\kanjiskip
      \\usepackage{pxjahyper}
      \\hypersetup{colorlinks=true}
    \\else
      \\ifdefined\\XeTeXversion
          \\hypersetup{colorlinks=true}
      \\else
        \\ifdefined\\directlua
          \\hypersetup{pdfencoding=auto,colorlinks=true}
        \\else
          \\hypersetup{unicode,colorlinks=true}
        \\fi
      \\fi
    \\fi
    % end org-latex-class bxjsarticle"
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
    (add-to-list
     'org-latex-classes
     '("jlreq"
       "% begin org-latex-class jlreq
  \\documentclass[11pt,paper=a4]{jlreq}
  [NO-DEFAULT-PACKAGES]
  \\usepackage{amsmath}
  \\usepackage{newtxtext,newtxmath}
  \\ifdefined\\kanjiskip
    \\usepackage[dvipdfmx]{graphicx}
    \\usepackage[dvipdfmx]{hyperref}
    \\usepackage{pxjahyper}
    \\hypersetup{colorlinks=true}
  \\else
    \\usepackage{graphicx}
    \\usepackage{hyperref}
    \\hypersetup{pdfencoding=auto,colorlinks=true}
  \\fi
  % end org-latex-class jlreq"
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
    (add-to-list
     'org-latex-classes
     '("jlreq-tate"
       "% begin org-latex-class jlreq-tate
  \\documentclass[tate,11pt,paper=a4]{jlreq}
  [NO-DEFAULT-PACKAGES]
  \\usepackage{amsmath}
  \\usepackage{newtxtext,newtxmath}
  \\ifdefined\\kanjiskip
    \\usepackage[dvipdfmx]{graphicx}
    \\usepackage[dvipdfmx]{hyperref}
    \\usepackage{pxjahyper}
    \\hypersetup{colorlinks=true}
  \\else
    \\usepackage{graphicx}
    \\usepackage{hyperref}
    \\hypersetup{pdfencoding=auto,colorlinks=true}
  \\fi
  % end org-latex-class jlreq-tate"
       ("\\section{%s}" . "\\section*{%s}")
       ("\\subsection{%s}" . "\\subsection*{%s}")
       ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
       ("\\paragraph{%s}" . "\\paragraph*{%s}")
       ("\\subparagraph{%s}" . "\\subparagraph*{%s}"))))
#+end_src

#+RESULTS:
: ox-latex

*** ソースコードの pretty print
- Windowsの場合
  - scoopでpygmentをインストールしておく
  - python インストールして pip install pygments
  - PATHの登録
    - C:\Users\yc\scoop\apps\python\current\Scripts

  #+begin_src emacs-lisp
    (setq org-export-latex-listings t)

    (setq org-latex-listings 'minted)
    (setq org-latex-minted-options
          '(("frame" "lines")
            ("framesep=2mm")
            ("linenos=true")
            ("baselinestretch=1.2")
            ("fontsize=\\footnotesize")
            ("breaklines")
            ))

    (add-to-list 'org-latex-packages-alist "\\usepackage{minted}" t)
  #+end_src

  #+RESULTS:
  | \usepackage{minted} |

*** Beamer

- beamerの作成は C-c C-e l P

#+begin_src emacs-lisp
  (require 'ox-beamer)
  (setq org-beamer-outline-frame-title "目次")
  (setq org-beamer-frame-default-options "t") ; フレームの位置をtopにする。
#+end_src

*** 参考文献 RefTex-Mode
    - [[https://taipapamotohus.com/post/org-mode_paper_3/][Emacsのorg-modeで論文を書く（その3：org-modeとbibtexとreftexの連携による文献引用の自動化） | A perfect autumn day]]
    - [[https://github.com/jkitchin/org-ref][jkitchin/org-ref: org-mode modules for citations, cross-references, bibliographies in org-mode and useful bibtex tools to go with it.]]
    - [[https://aliquote.org/post/org-and-bibtex/][Org and Bibtex - aliquote]]

    - org-refはHelmに依存しているようだ

      ;; (leaf org-ref
      ;;   :ensure t
      ;;   :require t
      ;;   :setq ((reftex-default-bibliography quote
      ;;                                       ("~/git/bibliography/references.bib"))

      ;;          (org-ref-bibliography-notes . "~/git/bibliography/notes.org")
      ;;          (org-ref-default-bibliography quote
      ;;                                        ("~/git/bibliography/references.bib"))
      ;;          (org-ref-pdf-directory . "~/git/bibliography/bibtex-pdfs/")

      ;;          (bibtex-completion-bibliography . "~/git/bibliography/references.bib")
      ;;          (bibtex-completion-library-path . "~/git/bibliography/bibtex-pdfs")
      ;;          (bibtex-completion-notes-path . "~/git/bibliography/helm-bibtex-notes")
      ;;          )
      ;;   :config
      ;;   (push '(migemo) helm-source-bibtex)

      ;;   ;; (define-key org-mode-map (kbd "C-c b c") `org-ref-helm-insert-cite-link)
      ;;   ;; (define-key org-mode-map (kbd "C-c b l") `org-ref-helm-insert-label-link)
      ;;   ;; (define-key org-mode-map (kbd "C-c b r") `org-ref-helm-insert-ref-link)
      ;;   )

#+begin_src emacs-lisp
  (leaf org-ref
    :package t
    :config
    (setq bibtex-completion-bibliography '("~/git/bibliography/references.bib")
          bibtex-completion-library-path '("~/git/bibliography/bibtex-pdfs/")
          bibtex-completion-notes-path "~/git/bibliography/notes/"
          bibtex-completion-notes-template-multiple-files "* ${author-or-editor}, ${title}, ${journal}, (${year}) :${=type=}: \n\nSee [[cite:&${=key=}]]\n"

          bibtex-completion-additional-search-fields '(keywords)
          bibtex-completion-display-formats
          '((article       . "${=has-pdf=:1}${=has-note=:1} ${year:4} ${author:36} ${title:*} ${journal:40}")
            (inbook        . "${=has-pdf=:1}${=has-note=:1} ${year:4} ${author:36} ${title:*} Chapter ${chapter:32}")
            (incollection  . "${=has-pdf=:1}${=has-note=:1} ${year:4} ${author:36} ${title:*} ${booktitle:40}")
            (inproceedings . "${=has-pdf=:1}${=has-note=:1} ${year:4} ${author:36} ${title:*} ${booktitle:40}")
            (t             . "${=has-pdf=:1}${=has-note=:1} ${year:4} ${author:36} ${title:*}"))
          bibtex-completion-pdf-open-function
          (lambda (fpath)
            (call-process "open" nil 0 nil fpath))))
#+end_src

#+RESULTS:
: org-ref

#+begin_src emacs-lisp
  (leaf bibtex
    :require t
    :config
    (setq bibtex-autokey-year-length 4
            bibtex-autokey-name-year-separator "-"
            bibtex-autokey-year-title-separator "-"
            bibtex-autokey-titleword-separator "-"
            bibtex-autokey-titlewords 2
            bibtex-autokey-titlewords-stretch 1
            bibtex-autokey-titleword-length 5
            org-ref-bibtex-hydra-key-binding (kbd "H-b"))

    (define-key bibtex-mode-map (kbd "H-b") 'org-ref-bibtex-hydra/body))
#+end_src

#+RESULTS:
: bibtex


- org-ref-insert-cite-function = nil
- org-ref-insert-label-function = nil
- org-ref-insert-ref-function = nil

** babel - Grophviz (dot)

- dotコードの評価を行うようにする
#+begin_src emacs-lisp
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((dot . t))) ; this line activates dot
#+end_src

- babelで評価するときに確認を出さない
  - [[https://emacs.stackexchange.com/questions/23946/how-can-i-stop-the-confirmation-to-evaluate-source-code-when-exporting-to-html][org mode - How can I stop the confirmation to evaluate source code when exporting to html? - Emacs Stack Exchange]]

#+begin_src emacs-lisp
  (setq org-confirm-babel-evaluate nil)
#+end_src

- インラインイメージの自動再描画
  - [[https://emacs.stackexchange.com/questions/3302/live-refresh-of-inline-images-with-org-display-inline-images][org mode - live refresh of inline images with org-display-inline-images - Emacs Stack Exchange]]

#+begin_src emacs-lisp
(eval-after-load 'org
  (add-hook 'org-babel-after-execute-hook 'org-redisplay-inline-images))
#+end_src

#+RESULTS:

** スピードコマンド

#+begin_src emacs-lisp
(setq org-use-speed-commands t)
#+end_src

#+RESULTS:
: t

** org2blog

#+begin_comment
- [[id:o2b:ee0b1a39-a8d8-494b-9e7d-02d794982f19][embark - カーソル位置にあるテキストに対するアクションを実行]]を
- org2blog-subtree-post-publishする
- シンタックスハイライトが崩れている
- 一旦、Wordpressで編集すると、うまくショートコードも入っている
- 改めて公開するとインデントが乱れる
- [[https://shop-hi-mall.com/wordpress-blank/][WordPressの文頭スペース（空白）が消える原因と対処法を解説！ - アフィリエイトゼミ]]をみて[[https://wordpress.org/plugins/tinymce-advanced/][Advanced Editor Tools (previously TinyMCE Advanced) – WordPress plugin | WordPress.org]]をインストール
- 一旦、編集して再度公開するとシンタックスハイライトが動作する
#+end_comment

+ 説明
  * orgでWordpressに投稿する
  * Buffer全体で記事を書く場合
    | キーn操作 | 関数                         | 説明                 |
    |-----------+------------------------------+----------------------|
    | C-c M-p g | org2blog-user-interface      | メニュー表示         |
    | C-c M-p D | org2blog-buffer-page-save    | ページをWPに保存     |
    | C-c M-p P | org2blog-buffer-page-publish | ページを公開         |
    | C-c M-p d | org2blog-buffer-post-save    | ポストをWPに保存     |
    | C-c M-p p | org2blog-buffer-post-publish | ポストを公開         |
    | C-c M-p t | org2blog-complete            | カテゴリやタグの補完 |

+ 参考
  * [[https://github.com/org2blog/org2blog#requirements-and-compatibility][org2blog/org2blog: Blog from Org mode to WordPress.]]
+ パスワードは~/.netrcに書く

+ 備考
  * ソースコードのエキスポートでエラー発生（2021-11-05）
  * どうやらコードに`(backquote)が2つあるとエラーになるようだ・・・
  * Wordpressのxmlrpcの問題か？セキュリティ対策？？
    - プロバイダのWAFの設定だった

#+begin_src emacs-lisp
  (leaf org2blog
    :ensure t
    :config
    (require 'auth-source)
    (let* ((credentials (auth-source-user-and-password "ploversky.net"))
           (username (nth 0 credentials))
           (password (nth 1 credentials))
           (config `("plover"
                     :url "https://ploversky.net/xmlrpc.php"
                     :username ,username
                     :password ,password)))
      (setq org2blog/wp-blog-alist `(,config)))
    (setq org2blog/wp-image-upload t)
    (setq org2blog/wp-show-post-in-browser 'show)
    (setq org2blog/wp-use-sourcecode-shortcode t)
    )
#+end_src

#+RESULTS:
: org2blog

** ox-hugo
- [[https://github.com/kaushalmodi/ox-hugo][GitHub - kaushalmodi/ox-hugo: A carefully crafted Org exporter back-end for Hugo]]

#+begin_src emacs-lisp
  (leaf ox-hugo
    :ensure t
    :require t
    :after ox)
#+end_src

#+RESULTS:
: ox-hugo

** org-superstar
  * org-bullets の進化版
    + [[https://github.com/integral-dw/org-superstar-mode/blob/master/DEMO.org][org-superstar-mode/DEMO.org at master · integral-dw/org-superstar-mode · GitHub]]
  * asterisk
    + plus
      - minus

#+begin_src emacs-lisp
  (leaf org-superstar
    :ensure t
    :config
    (add-hook 'org-mode-hook (lambda nil (org-superstar-mode 1))))
#+end_src

#+RESULTS:
: org-superstar

** org-rome

- org-romeを利用するための設定

#+begin_src emacs-lisp
  (leaf org-roam
    :ensure t
    :require t
    :custom
    (org-roam-directory . "~/Dropbox/Org/Roam/")
    (org-roam-completion-everywhere . t)
    (org-roam-capture-templates
     . '(("d" "default" plain
          "%?"
          :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+TITLE: ${title}\n")
          :unnarrowed t)
         ("m" "備忘録（Memo）" plain
          (file "~/Dropbox/Org/Roam/Templates/MemoTemplate.org")
          :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+TITLE: ${title}\n")
          :unnarrowed t)
         ("k" "会議録（Meeting）" plain
          (file "~/Dropbox/Org/Roam/Templates/MeetingTemplate.org")
          :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+TITLE: ${title}\n")
          :unnarrowed t)
         ("t" "文書（LaTeX）" plain
          (file "~/Dropbox/Org/Roam/Templates/LaTeXTemplate.org")
          :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+title: ${title}\n")
          :unnarrowed t)
         ("w" "ブログ（Wordpress）" plain
          (file "~/Dropbox/Org/Roam/Templates/Org2blogBufferTemplate.org")
          :if-new (file+head "%<%Y%m%d%H%M%S>-${slug}.org" "#+TITLE: ${title}\n")
          :unnarrowed t)
         ))
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n g" . org-roam-graph)
           ("C-c n i" . org-roam-node-insert)
           ("C-c n c" . org-roam-capture)
           ;; Dailies
           ("C-c n j" . org-roam-dailies-capture-today))
    :init
    (setq org-roam-v2-ack t)
    :config
    (org-roam-db-autosync-mode)
    ;; If using org-roam-protocol
    (require 'org-roam-protocol))
#+end_src

#+RESULTS:
: org-roam

** ox-zenn - zenn.devにブログを書く
*** 参考
+ [[https://zenn.dev/conao3/articles/ox-zenn-usage][org-modeドキュメントからZenn Flavored Markdownを生成するox-zennの使い方]]

#+begin_src emacs-lisp
  (leaf ox-zenn
    :ensure t
    :after org
    :require t ox-publish
  :defun zenn/f-parent org-publish
  :defvar org-publish-project-alist
  :preface
  (defvar zenn/org-dir "~/git/zenn-content")

  (defun zenn/org-publish (arg)
    "Publish zenn blog files."
    (interactive "P")
    (let ((force (or (equal '(4) arg) (equal '(64) arg)))
          (async (or (equal '(16) arg) (equal '(64) arg))))
      (org-publish "zenn" arg force async)))

  :config
  (setf
   (alist-get "zenn" org-publish-project-alist nil nil #'string=)
   (list
    :base-directory (expand-file-name "" zenn/org-dir)
    :base-extension "org"
    :publishing-directory (expand-file-name "../" zenn/org-dir)
    :recursive t
    :publishing-function 'org-zenn-publish-to-markdown)))
#+end_src

#+RESULTS:
: ox-zenn

** ox-pandoc - pandocでorgファイルからのエキスポートを拡張する
+ [[https://github.com/kawabata/ox-pandoc][kawabata/ox-pandoc: Another org-mode exporter via pandoc.]]

#+begin_src emacs-lisp
  (leaf ox-pandoc :package t :require t)
#+end_src

#+RESULTS:
: ox-pandoc

** org-pomodoro - ポモドーロテクニック
*** 設定

1. TODOのエントリーを書く
2. M-x org-pomodoroでタイマースタート
3. C-c C-x o で一時停止
4. C-c C-x TAB で再開
5. 時間が来るとアラーム？

C-c oでタイマーがスタートするよう設定しました。

#+begin_src emacs-lisp
    (leaf org-pomodoro
      :package t
      :require t
      :bind (("C-c p" . org-pomodoro)))
#+end_src

#+RESULTS:
: org-pomodoro

*** 参考
+ [[https://fnwiya.hatenablog.com/entry/2016/01/11/203000][emacsでポモドーロテクニック（org-pomodoro） - fnwiya's quine]]

** org-gcal - Googleカレンダーとの連携

https://github.com/kidd/org-gcal.el.git

#+begin_src emacs-lisp
  (leaf org-gcal
    :straight (org-gcal :type git :host github :repo "kidd/org-gcal.el")
    :require t
    :config
    (let* ((json-object-type 'hash-table)
           (json-array-type 'list)
           (json-key-type 'string)
           (gcal-json "~/Dropbox/Org/gcal/client_secret_357879820522-pnlalhj01143k1946fgp8ashshus9olg.apps.googleusercontent.com.json")
           (json (json-read-file gcal-json))
           (installed (gethash "installed" json))
           (client-id (gethash "client_id" installed))
           (client-secret (gethash "client_secret" installed)))
      (setq org-gcal-client-id client-id
            org-gcal-client-secret client-secret
            org-gcal-fetch-file-alist
            '(("yc@aiit.ac.jp" .  "~/Dropbox/Org/gcal/gcal-work.org")
              ("yoshihide.chubachi@gmail.com"
               .  "~/Dropbox/Org/gcal/gcal-private.org")))))
#+end_src

#+RESULTS:
: org-gcal

* 外部パッケージ
** swap-buffers
*** 設定

#+begin_src emacs-lisp
  (leaf swap-buffers
    :package t
    :bind
    ("C-c b" . swap-buffers)
    :custom
    (swap-buffers-qwerty-shortcuts
     . '("a" "o" "e" "u" "i" "d" "h" "t" "n" "s" "-")))
#+end_src

#+RESULTS:
: swap-buffers

*** 参考
+ [[http://emacs.rubikitch.com/swap-buffers/][swap-buffers.el : 【多分割対応】ウィンドウを入れ替える新しいコマンド]]
** backup-each-save - Emacsで保存するたびに自動でバックアップ     :PBLISHED:
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-20 21:43:40]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, Lisp
:ID:       o2b:1712bebe-b383-4335-ad81-c10f995c1ee0
:POST_DATE: [2021-11-20 Sat 21:43]
:POSTID:   378
:END:

るびきちさんの[[http://emacs.rubikitch.com/backup-each-save/][こちら]]の記事からです。[[http://emacs.rubikitch.com/real-auto-save/][real-auto-save.el]]はそこまではいらないかな、という感じです。割としょっちゅうC-x C-sを打っている気がするので。

#+begin_src emacs-lisp
  (leaf backup-each-save
    :package t
    :config
    ;; バックアップ先
    (setq backup-each-save-mirror-location "~/.emacs.d/backups")
    ;; バックアップファイルにつけるsuffix
    (setq backup-each-save-time-format "%y%m%d_%H%M%S")
    ;; バックアップするファイルサイズの上限
    (setq backup-each-save-size-limit 5000000)
    ;; すべてのファイルをバックアップする
    (setq backup-each-save-filter-function 'identity)
    ;; 有効化！
    (add-hook 'after-save-hook 'backup-each-save))
#+end_src

#+RESULTS:
: backup-each-save

** undo-tree
   - [[https://elpa.gnu.org/packages/undo-tree.html][GNU ELPA - undo-tree]]

   #+begin_src emacs-lisp
     (leaf undo-tree
       :ensure t
       :config
       (global-undo-tree-mode))
   #+end_src

** fly-check

- emacs-lispのドキュメント用のチェック(emacs-lisp-checkdoc)を無効にする。

#+begin_src emacs-lisp
  (leaf flycheck
    :doc "On-the-fly syntax checking"
    :emacs>= 24.3
    :ensure t
    :bind (("M-n" . flycheck-next-error)
           ("M-p" . flycheck-previous-error))
    :custom ((flycheck-emacs-lisp-initialize-packages . t)
             (flycheck-disabled-checkers . '(emacs-lisp-checkdoc)))
    :hook (emacs-lisp-mode-hook lisp-interaction-mode-hook)
    :config
    (leaf flycheck-package
      :doc "A Flycheck checker for elisp package authors"
      :ensure t
      :config
      (flycheck-package-setup))

    (leaf flycheck-elsa
      :doc "Flycheck for Elsa."
      :emacs>= 25
      :ensure t
      :config
      (flycheck-elsa-setup))
    )
#+end_src

** pandoc-mode

- C-c / でメニュー表示
- http://joostkremers.github.io/pandoc-mode/

#+begin_src emacs-lisp
  (leaf pandoc-mode
    :doc "Minor mode for interacting with Pandoc"
    :req "hydra-0.10.0" "dash-2.10.0"
    :tag "pandoc" "text"
    :added "2020-11-24"
    :url "http://joostkremers.github.io/pandoc-mode/"
    :ensure t
    :after hydra)
#+end_src

** magit
- EmacsのGit
#+begin_src emacs-lisp
  (leaf magit
    :doc "A Git porcelain inside Emacs."
    :req "emacs-25.1" "async-20200113" "dash-20200524" "git-commit-20200516" "transient-20200601" "with-editor-20200522"
    :tag "vc" "tools" "git" "emacs>=25.1"
    :added "2020-11-30"
    :emacs>= 25.1
    :ensure t
    :after git-commit with-editor
    :bind (("C-x g" . magit-status))
    )
#+end_src

#+RESULTS:
: magit

- [[http://tanehp.ec-net.jp/heppoko-lab/prog/resource/magit/magit_memo.html#%E5%A4%89%E6%9B%B4%E3%82%92%E6%88%BB%E3%81%99][Magit の覚え書き]]
  - Discard

** migemo
*** Linux
- .emacs.d/migemo-dictを用意
  - cmigemoをインストールして
  - /usr/share/cmigemo/utfg-8/migemo-dictをコピー
- [[https://github.com/emacs-jp/migemo][emacs-jp/migemo: emacs migemo client]]
#+begin_src emacs-lisp
  (leaf migemo
    :when (eq system-type 'gnu/linux)
    :ensure t
    :require t
    :config
    ;; cmigemo(default)
    (setq migemo-command "cmigemo")
    (setq migemo-options '("-q" "--emacs"))

    ;; ruby migemo
    ;; (setq migemo-command "ruby")
    ;; (setq migemo-options '("-S" "migemo" "-t" "emacs" "-i" "\a"))

    ;; Set your installed path
    (setq migemo-dictionary "/usr/share/cmigemo/utf-8/migemo-dict")

    (setq migemo-user-dictionary nil)
    (setq migemo-regex-dictionary nil)
    (setq migemo-coding-system 'utf-8-unix)
    (migemo-init)
    )
#+end_src

#+RESULTS:
: migemo

*** Windows
- [[https://hangstuck.com/emacs-cmigemo-windows/][Windowsでの Emacsでmigemo を有効にする設定方法 | ハングスタック]]
- migemoの辞書は絶対パスで参照する
- その他の変数はデフォルトで動作する
- とりあえずWindowsで動くようにした

#+begin_src emacs-lisp
  (leaf migemo
    :when (and
           (eq system-type 'windows-nt)
           (file-exists-p "C:/Users/yc/lib/cmigemo-default-win64/dict/utf-8/migemo-dict"))
    :ensure t
    :setq
    (migemo-dictionary . "C:/Users/yc/lib/cmigemo-default-win64/dict/utf-8/migemo-dict")
    :config
    (load-library "migemo")
    (migemo-init))
#+end_src

  #+RESULTS:
  : migemo

** yasnippet
- [[https://github.com/joaotavora/yasnippet][joaotavora/yasnippet: A template system for Emacs]]
- サンプルは次の場所にあるので必要なものは ~/.emacs.d/snippets にコピー
  - ~/.emacs.d/elpa/yasnippet-snippets-20210910.1959/snippets/

- :setq を使う場合の注意
  - :init だと :init -> :setq の順番でNG
  - :config なら :setq -> :init
- :require との関係
  -  :init -> :require -> :setq -> :config

- :require なし
  - :init -> NG

- マクロ展開
    #+begin_src
  (prog1 'yasnippet-snippets
    (leaf-handler-leaf-path yasnippet-snippets)
    (leaf-handler-leaf-protect yasnippet-snippets
      (leaf-handler-package yasnippet-snippets yasnippet-snippets nil)
      (yas-global-mode 1) ; <- 2
      (setq yasnippet-snippets-dir "~/.emacs.d/snippets"))) ; <- 1
    #+end_src

  - :config -> NG

    #+begin_src
  (prog1 'yasnippet-snippets
    (leaf-handler-leaf-path yasnippet-snippets)
    (leaf-handler-leaf-protect yasnippet-snippets
      (leaf-handler-package yasnippet-snippets yasnippet-snippets nil)
      (setq yasnippet-snippets-dir "~/.emacs.d/snippets") ; <- 1
      (yas-global-mode 1))) ; <- 2
    #+end_src

- :require あり

  - :init -> NG

    #+begin_src
(prog1 'yasnippet-snippets
  (leaf-handler-leaf-path yasnippet-snippets)
  (leaf-handler-leaf-protect yasnippet-snippets
    (leaf-handler-package yasnippet-snippets yasnippet-snippets nil)
    (yas-global-mode 1)
    (require 'yasnippet-snippets)
    (setq yasnippet-snippets-dir "~/.emacs.d/snippets")))
    #+end_src

  - :config -> OK

[[https://qiita.com/conao3/items/dc88bdadb0523ef95878][「:prefaceは条件分岐キーワードより先に展開したい」などの順序に関する問題を解決するために、 leaf は整形されたplistを「善い順番」に並び替えます。  その「善い順番」は内部変数のleaf-keywordsの並び順で、 *scratch* で (pl (leaf-available-keywords)) を評価することで得ることができます。]]

    #+begin_src
(prog1 'yasnippet-snippets
  (leaf-handler-leaf-path yasnippet-snippets)
  (leaf-handler-leaf-protect yasnippet-snippets
    (leaf-handler-package yasnippet-snippets yasnippet-snippets nil)
    (require 'yasnippet-snippets)
    (setq yasnippet-snippets-dir "~/.emacs.d/snippets")
    (yas-global-mode 1)))
    #+end_src

#+begin_src emacs-lisp
  (leaf yasnippet-snippets
    :package t
    :require t
    :setq
    (yasnippet-snippets-dir . "~/.emacs.d/snippets")
    :config
    (custom-set-variables
     '(warning-suppress-types (quote ((yasnippet backquote-change)))))
    (yas-global-mode 1))
#+end_src

#+RESULTS:
: yasnippet-snippets

** multiple-cursors
+ [[https://dev.classmethod.jp/articles/emacs-multiple-cursors/][複数カーソルを操作するパッケージ multiple-cursors.el のご紹介 | DevelopersIO]]

+ リージョンを選択してカーソルをあわせる
+ region-bindings-modeとともに使うとよい

#+begin_src emacs-lisp
    (leaf multiple-cursors
      :package t
      :config
      ;; use region-bindings-mode instead
      ;; (global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
      ;; (global-set-key (kbd "C->")         'mc/mark-next-like-this)
      ;; (global-set-key (kbd "C-<")         'mc/mark-previous-like-this)
      ;; (global-set-key (kbd "C-c C-<")     'mc/mark-all-like-this))
      )
#+end_src

#+RESULTS:
: multiple-cursors

** region-bindings-mode
+ [[https://tam5917.hatenablog.com/entry/20130129/1359465171][region-bindings-modeの紹介 - 備忘録]]
+ [[https://github.com/magnars/expand-region.el][magnars/expand-region.el: Emacs extension to increase selected region by semantic units.]]
+ [[https://github.com/fgallina/region-bindings-mode][GitHub - fgallina/region-bindings-mode: A minor mode that enables custom bindings when mark is active.]]

#+begin_src emacs-lisp
  (leaf region-bindings-mode
    :package t
    :require t
    :config
    (region-bindings-mode-enable)
    (define-key region-bindings-mode-map "e" 'mc/edit-lines)
    (define-key region-bindings-mode-map "a" 'mc/mark-all-like-this)
    (define-key region-bindings-mode-map "p" 'mc/mark-previous-like-this)
    (define-key region-bindings-mode-map "n" 'mc/mark-next-like-this)
    (define-key region-bindings-mode-map "m" 'mc/mark-more-like-this-extended)
    )
#+end_src

#+RESULTS:
: region-bindings-mode

** yaml-mode

#+begin_src emacs-lisp
  (leaf yaml-mode :package t)
#+end_src

#+RESULTS:
: yaml-mode

+ 参考
  * [[https://github.com/DarthFennec/highlight-indent-guides][DarthFennec/highlight-indent-guides: Emacs minor mode to highlight indentation]]

** rainbow-delimiters
*** 説明

#+begin_src emacs-lisp
  (leaf rainbow-delimiters
    :package t
    :hook
    (prog-mode-hook . rainbow-delimiters-mode))
#+end_src

#+RESULTS:
: rainbow-delimiters

*** 参考
+ [[https://qiita.com/Ladicle/items/feb5f9dce9adf89652cf#%E6%8B%AC%E5%BC%A7%E3%81%8C%E5%A4%9A%E3%81%84%E3%81%A8%E8%99%B9%E3%81%8C%E3%81%BF%E3%81%88%E3%82%8B----rainbow-delimiters][Emacsモダン化計画 -かわEmacs編- - Qiita]]

** highlight-indent-guides
*** 説明
ソースコードを編集するとき、インデントのガイドを表示する。

*** 設定
#+begin_src emacs-lisp
  (leaf highlight-indent-guides
    :package t
    :require t
    :hook
    ((prog-mode-hook yaml-mode-hook) . highlight-indent-guides-mode)
    :custom
    (highlight-indent-guides-auto-enabled . t)
    (highlight-indent-guides-responsive . t)
    (highlight-indent-guides-method . 'character)) ; column
#+end_src

#+RESULTS:
: highlight-indent-guides

*** 参考
+ [[https://qiita.com/Ladicle/items/feb5f9dce9adf89652cf#yaml%E3%81%AE%E9%9A%8E%E5%B1%A4%E6%A7%8B%E9%80%A0%E3%81%AB%E8%B2%A0%E3%81%91%E3%81%AA%E3%81%84----highlight-indent-guides][Emacsモダン化計画 -かわEmacs編- - Qiita]]

** beacon
*** 設定

#+begin_src emacs-lisp
  (leaf beacon
    :package t
    :custom
    (beacon-mode . t))
#+end_src

#+RESULTS:
: beacon

*** 参考
+ [[https://qiita.com/Ladicle/items/feb5f9dce9adf89652cf#%E3%82%82%E3%81%86%E3%82%AB%E3%83%BC%E3%82%BD%E3%83%AB%E3%82%92%E8%A6%8B%E5%A4%B1%E3%82%8F%E3%81%AA%E3%81%84----beacon][Emacsモダン化計画 -かわEmacs編- - Qiita]]

** git-gutter

#+begin_src emacs-lisp
  (leaf git-gutter
    :package t
    ;; :custom
    ;; (git-gutter:modified-sign . "~")
    ;; (git-gutter:added-sign    . "+")
    ;; (git-gutter:deleted-sign  . "-")
    ;; :custom-face
    ;; (git-gutter:modified . ((t (:background "#f1fa8c"))))
    ;; (git-gutter:added    . ((t (:background "#50fa7b"))))
    ;; (git-gutter:deleted  . ((t (:background "#ff79c6"))))
    :custom
    (global-git-gutter-mode . t))
#+end_src

#+RESULTS:
: git-gutter

** DONE shell-pop - いつでもどこでもshellを出す                  :published:
CLOSED: [2021-11-09 Tue 20:23]
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-09 20:16:56]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, Lisp
:ID:       o2b:dc0f7103-fb58-4bae-96e1-54699516f5b0
:POST_DATE: [2021-11-09 Tue 20:17]
:POSTID:   254
:END:
*** 説明
Emacsで作業中に、shellで作業をしたくなることはよくあります。そのような際に便利な設定です。

*** 設定
公式[fn:1]ではC-tに割り当てていますが、私は標準のC-tをわりと多用します。なので、C-c sにアサインしました。
# 私はC-zにしています。ターミナルでEmacsを立ち上げたとき、ちょっとshellで作業をしたいと思ったらC-zでサスペンドします。そのイメージがあるので、shell使いたいな、と思うと勝手に手が反応します。shellを使い終わったら、もう一度C-zで閉じます。

#+begin_src emacs-lisp
  (leaf shell-pop
    :package t
    :require t
    :custom
    ((shell-pop-universal-key . "C-c s")
     (shell-pop-shell-type . (quote ("eshell" "*eshell*" (lambda nil (eshell shell-pop-term-shell)))))
     (shell-pop-window-position . "bottom")
     (setq shell-pop-full-span . t)))
#+end_src

#+RESULTS:
: shell-pop

# ターミナルはansi-termにしました[fn:2]（6行目）。
ターミナルはeshellにしました[fn:2]（6行目）。
また、常に画面の下部に出すようにしています（7行目）。
ウインドウの幅いっぱいに表示します（87行目）。

[fn:1] [[https://github.com/kyagi/shell-pop-el][kyagi/shell-pop-el: shell-pop.el helps you to use shell easily on Emacs. Only one key action to work.]]

[fn:2] [[https://blog.inouetakuya.info/entry/20110627/1309175529][Emacs のシェルモード比較 - shell、ansi-term、multi-term - 彼女からは、おいちゃんと呼ばれています]]

** DONE visual-fill-column - 長い行を任意の桁で折り返す          :published:
CLOSED: [2021-11-10 Wed 11:12]
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-08 22:19:48]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs
:ID:       o2b:88634903-8b8b-44b8-9b7f-a50fdc58ed5d
:POST_DATE: [2021-11-08 Mon 22:21]
:POSTID:   218
:END:
*** 長い行を折り返す？折り返さない？
Emacsでは長い行を折返して表示してくれます。

[[https://ploversky.net/wp-content/uploads/2021/11/emacs-long-line.png]]

行が繋がっていることを示す矢印のアイコンが、画面の左右にいっぱい出ていますね。

この折返しをしなくするには、変数truncate-linesをtに設定します。

#+begin_example
M-x set-variable
truncate-lines
t
#+end_example
そうすると、

https://ploversky.net/wp-content/uploads/2021/11/emacs-long-line-truncate.png

長い文の前の一部分だけ、表示されるようになりました。カーソルを右に移動すれば、全体を読むことができます。プログラミングするときには便利です。

*** 改行で長い行を分割する
この長い行でM-qを押します（fill-paragraph）。すると、

https://ploversky.net/wp-content/uploads/2021/11/emacs-long-line-fill-paragraph.png

長い一つの行に、改行が挿入されて複数の行に分割されました。このとき、一つの行の長さは72文字を超えない長さになります。Emacsのヘルプやマニュアルを見るとこのようなスタイルですね。紙に印刷するときも、このスタイルならはみ出て読めなくなることもありません。昔はメールもこんな感じで書くのが普通でした。

*** 一行を分割しないで折返し位置を自由に設定したい
さて、時は流れて、いまやメールもHTMLで書く時代です（好むと好まざるにかかわらず）。小さな画面のスマートフォンでメールを読むこともあります。そんなとき、72文字ごとに改行がはいると、非常に読みづらくなります。一行は一行のままで、表示をするときには画面のサイズに応じた位置で改行してほしいですよね。

ただし、デフォルトの設定だとウインドウの端で折り返されているため、少し読みにくいと思いませんか？一行は一行のまま、自動で改行してほしい、そのとき、改行する位置を指定したい。こんなときに利用できるパッケージがvisual-fill-columモードです。

https://ploversky.net/wp-content/uploads/2021/11/emacs-long-line-visual-fill-column.png

一行は一行のまま、72文字で折返してくれています。一行の長さが短くなり、多少は読みやすくなってますね。

*** visula-fill-columnのインストール
パッケージをインストールするには次の通り設定します。

#+begin_src emacs-lisp
  (leaf visual-fill-column
    :doc "fill-column for visual-line-mode"
    :req "emacs-25.1"
    :tag "emacs>=25.1"
    :url "https://github.com/joostkremers/visual-fill-column"
    :added "2021-11-08"
    :emacs>= 25.1
    :ensure t
    :bind(("C-c q" . visual-fill-column-mode)
          (:visual-fill-column-mode-map
           ("C-a" . beginning-of-visual-line)
           ("C-e" . end-of-visual-line)
           ("C-k" . kill-visual-line))))
#+end_src

#+RESULTS:
: visual-fill-column

C-c qにvisual-fill-column-modeにするキーを割り当てました。M-qでfill-paragraphするアナロジーです。

また、一行を基準に動作する標準のキーを、画面の一行を基準に動作するコマンドに、次の通り置き換えています[fn:1]。

| キー | 説明                          |
|------+-------------------------------|
| C-a  | *画面上の* 行の一番先頭に移動 |
| C-e  | *画面上の* 行の一番末尾に移動 |
| C-k  | *画面上の* 行を一行削除       |

この設定により、折り返す桁を自由に指定できる上に、画面上の一行を単位として編集できます。

折り返す位置は指定できます。折り返したい桁にカーソルを合わせ、 C-u C-x f を押すと、その位置で改行するようになります。あるいは C-u 50 C-x f のように、桁数を引数に与えてもよいです。なお、設定しただけでは表示は変わりません。何か文字を入力すると、変わります。

https://ploversky.net/wp-content/uploads/2021/11/emacs-long-line-visual-fill-column-50.png

*** 単語の途中で折り返さないようにするには
さて、日本語で入力するのであればこのままでもよいのですが、英語の場合、単語の途中で折り返されるのは嫌ですね。そんなときは visual-line-mode を使います。このモードは標準装備です。M-x visual-line-modeで設定できます。

https://ploversky.net/wp-content/uploads/2021/11/emacs-long-line-visual-line-mode.png

単語が途中で改行されないので、見やすくなりました。この行は全て繋がっていますが、矢印のアイコンもでなくなりました。ただし、日本語の文書でこの設定をしてしまうと、逆に見づらいです（日本語には単語の区切り（空白）がないので、逆にどこで改行するか判断しにくい）。

#+begin_comment
Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent ante nisl, condimentum vitae blandit porttitor, ultricies in enim. Integer sit amet mi tincidunt, blandit metus id, finibus quam. Donec egestas tortor at metus condimentum, at varius magna venenatis. Nullam auctor ipsum quis massa semper, non eleifend quam accumsan. Etiam sed dui nisl. Nulla ac tempus nulla. Nulla facilisi. Cras ligula elit, rutrum in augue volutpat, pharetra tempus metus. Aliquam nibh est, scelerisque sit amet nisi non, aliquam volutpat nibh. Pellentesque consequat dui eros, sed fermentum augue tincidunt eu. Quisque eget tristique massa, eu gravida nunc.
#+end_comment

*** まとめ
日本語の場合、

1. truncate-linesはnil（標準のまま）
2. visual-fill-columnパッケージをインストールして桁数を設定

すると、自由に好きな位置で折返し表示させて編集できるようになります。

英語の場合、追加で

3. visual-line-modeを利用（標準で利用可）

となります。

*** 参考
+ [[https://github.com/joostkremers/visual-fill-column][joostkremers/visual-fill-column: Emacs mode for wrapping visual-line-mode buffers at fill-column.]]
  * visual-fill-columnパッケージのサイト
+ [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Visual-Line-Mode.html][https://www.gnu.org/software/emacs/manual/html_node/emacs/Visual-Line-Mode.html]]
  * visual-line-modeの説明

[fn:1] orgモードではC-kにorg-kill-lineが割り当てられます。これを上書きすることで弊害がおきるかもしれませんが、未確認です。

*** COMMENT コメント
+ mu4eでメールを書くときに利用する。
+ [[https://www.gnu.org/software/emacs/manual/html_node/elisp/Adaptive-Fill.html][https://www.gnu.org/software/emacs/manual/html_node/elisp/Adaptive-Fill.html]]
  * Adaptive Fill Modeと組み合わせることも（調査中）
+ [[https://github.com/joostkremers/visual-fill-column#centering-the-text][joostkremers/visual-fill-column: Emacs mode for wrapping visual-line-mode buffers at fill-column.]]
  * センタリングすることも

* UI・見た目
** modus-themes
- [[https://protesilaos.com/modus-themes/][Modus Themes (Modus Operandi and Modus Vivendi) | Protesilaos Stavrou]]

#+begin_src emacs-lisp
  (leaf modus-themes
    :ensure t                        ; omit this to use the built-in themes
    :init
    ;; Add all your customizations prior to loading the themes
    (setq modus-themes-italic-constructs t
          modus-themes-bold-constructs nil
          modus-themes-region '(bg-only no-extend))

    ;; Load the theme files before enabling a theme (else you get an error).
    (modus-themes-load-themes)
    :config
    ;; Load the theme of your choice:
    (modus-themes-load-operandi) ;; OR (modus-themes-load-vivendi)
    :bind ("<f5>" . modus-themes-toggle))
#+end_src

#+RESULTS:
: modus-themes

** whitespace - 空白文字の可視化
- [[https://yanqirenshi.hatenablog.com/entry/2016/07/03/Emacs%3A_whitespace_%E3%81%A7%E4%BD%99%E5%88%86%E3%81%AA%E7%A9%BA%E7%99%BD/%E3%82%BF%E3%83%96%E3%81%AB%E8%89%B2%E3%81%A5%E3%81%91][Emacs: whitespace で余分な空白/タブに色づけ - ほんとのこと知りたいだけなのに。]]
  - M-x list-faces-display で設定する色の種類と色を確認できます。
  - 設定する色は M-x list-colors-display で確認する感じ。
- 色はテーマのデフォルトのままにしておく。

　　　ああ全角　　　　　←全角　あいうえお
あいうえお　漢字

#+begin_src emacs-lisp
  (leaf whitespace
    :require 't
    :config
    (setq whitespace-style
          '(
            face ; faceで可視化
            trailing ; 行末
            tabs ; タブ
            spaces ; スペース
            space-mark ; 表示のマッピング
            tab-mark
            ))
    (setq whitespace-display-mappings
          '(
            (space-mark ?\u3000 [?□])
            (tab-mark ?\t [?\u00BB ?\t] [?\\ ?\t])
            ))
    (setq whitespace-trailing-regexp  "\\([ \u00A0]+\\)$")
    (setq whitespace-space-regexp "\\(\u3000+\\)")
    ;; (set-face-attribute 'whitespace-trailing nil
    ;;                     :foreground nil
    ;;                     :background "DarkOrange1"
    ;;                     :underline nil)
    ;; (set-face-attribute 'whitespace-tab nil
    ;;                     :foreground "DarkOrange1"
    ;;                     :background nil
    ;;                     :underline nil)
    ;; (set-face-attribute 'whitespace-space nil
    ;;                     :foreground "DarkOrange1"
    ;;                     :background nil
    ;;                     :underline nil)
    (global-whitespace-mode t))
#+end_src

#+RESULTS:
: whitespace

** all-the-icons
- [[https://github.com/domtronn/all-the-icons.el][GitHub - domtronn/all-the-icons.el: A utility package to collect various Icon Fonts and propertize them within Emacs.]]

- パッケージ導入後、 M-x all-the-icons-install-fonts でOSにフォントを
  インストールする

#+begin_src emacs-lisp
  (leaf all-the-icons :ensure t)
#+end_src

#+RESULTS:
: all-the-icons

** doom-modeline - モードラインにアイコン表示

  #+begin_src emacs-lisp
    (leaf doom-modeline
      :ensure t
      :custom
      ;; (doom-modeline-buffer-file-name-style . 'truncate-with-project)
      ;; (doom-modeline-icon . t)
      ;; (doom-modeline-major-mode-icon . nil)
      ;; (doom-modeline-minor-modes . nil)
      :init
      ;; (after-init . doom-modeline-mode)
      (doom-modeline-mode 1)
      :config
      ;; (line-number-mode 1)
      ;; (column-number-mode 0)
      ;;   (doom-modeline-def-modeline 'main
      ;; '(bar workspace-number window-number evil-state god-state ryo-modal xah-fly-keys matches buffer-info remote-host buffer-position parrot selection-info)
          ;; '(misc-info persp-name lsp github debug minor-modes input-method major-mode process vcs checker))
      )
  #+end_src

  #+RESULTS:
  : doom-modeline

* メール/Web
** smtpmail - メールの送信
*** 説明
+ 最初のメールを送信時、パスワードを入力すると、~/.authinfo に自動で追加

;; sending mail -- replace USERNAME with your gmail username
;; also, make sure the gnutls command line utils are installed
;; package 'gnutls-bin' in Debian/Ubuntu

#+begin_src emacs-lisp
  (leaf smtpmail
    :require t
    :setq ((message-send-mail-function quote smtpmail-send-it)
           (starttls-use-gnutls . t)
           (smtpmail-starttls-credentials '(("smtp.gmail.com" 587 nil nil)))
           (smtpmail-auth-credentials '(("smtp.gmail.com" 587 "yc@aiit.ac.jp" nil)))
           (smtpmail-default-smtp-server . "smtp.gmail.com")
           (smtpmail-smtp-server . "smtp.gmail.com")
           (smtpmail-smtp-service . 587)))
#+end_src

#+RESULTS:
: smtpmail

** shr/eww - Simple HTML Reader
+ 説明
  * EmacsのWebブラウザに関する設定
  * ewwはデフォルトだと読みにくいプロポーショナルフォントになる
  * mu4eではメールを読む際にshrを使う
+ 文献
  * [[https://www.emacswiki.org/emacs/eww][[Home] eww]]
+ 設定
  * ewwを標準にするにはbrowse-url-browser-functionを設定する
  * shr-use-fontsをnilに設定することで、固定幅フォントを使うようになる

#+begin_src emacs-lisp
  (leaf eww
    :custom
    (
     ;; (browse-url-browser-function . 'eww-browse-url)
     (shr-use-colors    . nil)
     (shr-use-fonts     . nil)
     (shr-image-animate . nil)
     (shr-width         . 72)
     (eww-search-prefix . "https://www.google.com/search?q=")
     )
    )
#+end_src

#+RESULTS:
: eww

** notmuch - 高速Maildir検索ツール用のインタフェイス
*** メモ
+ [[https://notmuchmail.org/notmuch-emacs/#index1h1][notmuch-emacs]]

+ [[https://notmuchmail.org/notmuch-emacs/#index5h2][After Notmuch is loaded notmuch-init-file (typically ~/.emacs.d/notmuch-config.el) is checked out.]]

+ orgのannotationに対応していないかも・・・
+ カスタマイズ変数
  * '(notmuch-draft-folder "Gmail/drafts")
    - ドラフトはGmailのdraftsへ
    - notmuch-fcc-dirs . nil
  * '(notmuch-fcc-dirs nil)
    - FCC (file carbon copy) はなしでGmailに任せる
+ inboxかどうかをタグで判断している？+inbox
  * imapのタグとnotmuchのタグは違う？
+ 新しいメールを受信したら、notmuch newが必要
+ Maildirを移動する方法不明
+ [[https://githubmemory.com/repo/minad/vertico/issues/119][Notmuch.el select tag error: "Tag must be in the form of +'this_tag' or '-that_tag'" - githubmemory]]
  * Verticoでタグを操作する場合のバグを回避

+ [[https://notmuchmail.org/howto/][Index and search emails written in CJK scripts]]
  + 日本語の場合、XAPIAN_CJK_NGRAM=1

+ imapでnewに入ったメールをcurに移すときファイル名に
  * [[http://cr.yp.to/proto/maildir.html][When you move a file from new to cur, you have to change its name from uniq to uniq:info.]]
  * P,R,S,T,D,Fのフラグをつける
  * メーラで開いたとき、Sのフラグがついてnewからcurに移る
+ それとは別に，inboxとunreadのフラグがつく（inboxはnotmuchのスペシャルタグ）

  + たぶんnotmuch newのとき
+ notmuchでInboxを見るには？
  + search path:/Gmail\/inbox/ <-正規表現
+ notmuchのarchiveとは
  * inbox tagを削除すること
  * ファイルの移動は行わない？
+ そもそもGmailのInboxとは？
  * [[https://www.gmailhelplinenumber.co.uk/gmail-help-desk-number-uk.html][Gmail inbox is that folder in which only the non-archived emails are kept. ]]
  * Gmail All Mailの一部でアーカイブされていないもの
  * Gmail上でarchiveにはinboxのメールも表示される
  * Gmailでinboxをアーカイブしてもローカルのinbox/curにのこり続けるようだ
    - mbsync で消えそうだけど・・・
      - mbsnc の設定ぽいなあ
    - [[https://www.seanh.cc/2021/08/22/backup-fastmail-and-gmail-with-isync/][Expunge Slave        # Expunge deleted messages from the local copy.]]
    - [[https://www.seanh.cc/2021/08/22/backup-fastmail-and-gmail-with-isync/][The Pipelinedepth 1 slows isync down by preventing it from having multiple IMAP commands in flight at once. This is necessary to prevent isync from hitting Gmail’s bandwidth quotas and triggering this error message:]]
    - 削除された

+ mbsyncを定期的に実行するには
  - watch -n 180 mbsync -a
  - [[https://wiki.archlinux.org/title/isync#Calling_mbsync_automatically][With imapnotify]]
  - WSLではどれがいい？ nohup で

+ スレッドモードの操作

| キー | 説明               |
|------+--------------------|
| m    | 新規メッセージ     |
| n    | 次の行             |
| SPC  | メールを読み進める |
| M-n  | 次のスレッド       |

*** 設定:notmuch

+ [[https://githubmemory.com/repo/minad/vertico/issues/119][Notmuch.el select tag error: "Tag must be in the form of +'this_tag' or '-that_tag'" - githubmemory]]
  * verticoでタグが入力できない問題を回避する
+ [[https://notmuchmail.org/emacstips/#index5h2][Add a key binding to add/remove/toggle a tag]]

#+begin_src emacs-lisp
  (leaf notmuch
    :package t
    :require t
    :hook
    (notmuch-message-mode-hook . visual-fill-column-mode)
    (notmuch-message-mode-hook . (lambda () (auto-fill-mode -1)))
    :custom
    ((notmuch-draft-folder . "Gmail/draft") ; ドラフトをGmailのフォルダに
     (notmuch-fcc-dirs . nil) ; 送信済みメールはローカルに保存せずGmailに任せる
     (notmuch-search-oldest-first . nil) ; 検索結果を新しい順でソート
     (notmuch-saved-searches
      . '((:name "inbox"      :query "tag:inbox folder:/Gmail\\/inbox/ AND NOT tag:deleted"
                 :key "i")
          (:name "unread"     :query "tag:unread AND NOT tag:deleted"  :key "u")
          (:name "flagged"    :query "tag:flagged AND NOT tag:deleted" :key "f")
          (:name "sent"       :query "tag:sent AND NOT tag:deleted"    :key "s")
          (:name "drafts"     :query "tag:draft AND NOT tag:deleted"   :key "d")
          (:name "Gmal Inbox" :query "folder:/Gmail\\/inbox/"          :key "I")
          (:name "Gmal Sent"  :query "folder:/Gmail\\/sent/"           :key "S")
          (:name "all mail"   :query "NOT tag:deleted"                 :key "a")))
     )
    :bind (("C-c m" . notmuch-hello))
    :config
    (advice-add #'notmuch-read-tag-changes
                :filter-return (lambda (x) (mapcar #'string-trim x))) ; vertico対策
    :config
    (define-key notmuch-search-mode-map "f"
      (lambda ()
        "toggle flaged tag for message"
        (interactive)
        (if (member "flagged" (notmuch-search-get-tags))
            (notmuch-search-tag (list "-flagged"))
          (notmuch-search-tag (list "+flagged")))))
    (define-key notmuch-show-mode-map "f"
      (lambda ()
        "toggle flaged tag for message"
        (interactive)
        (if (member "flagged" (notmuch-show-get-tags))
            (notmuch-show-tag (list "-flagged"))
          (notmuch-show-tag (list "+flagged")))))
    (define-key notmuch-tree-mode-map "f"
      (lambda ()
        "toggle flaged tag for message"
        (interactive)
        (if (member "flagged" (notmuch-tree-get-tags))
            (notmuch-tree-tag (list "-flagged"))
          (notmuch-tree-tag (list "+flagged"))))))
#+end_src

#+RESULTS:
: notmuch

*** ol-notmuch

+ orgのリンクをnotmuchに対応させる
  - storeはできるけど・・・？
+ [[https://notmuchmail.org/emacstips/][Note the package was renamed from org-notmuch to ol-notmuch in recent versions of org-mode.]]

#+begin_src emacs-lisp
  (leaf ol-notmuch
    :package t
    :after notmuch org)
#+end_src

#+RESULTS:
: ol-notmuch

*** consult-notmuch
notmuchのconsultで検索（結果が多いと落ちるようだ）

#+begin_src emacs-lisp
  (leaf consult-notmuch
    :el-get emacsmirror/consult-notmuch
    :after consult notmuch)
#+end_src

#+RESULTS:
: consult-notmuch

** gnus-alias - notmuchでシグネチャ

+ [[https://www.emacswiki.org/emacs/gnus-alias.el][http://github.com/hexmode/gnus-alias/]]
+ [[https://notmuchmail.org/emacstips/][gnus-alias allows you to define multiple identities when using message-mode.]]

#+begin_src emacs-lisp
  (leaf gnus-alias
    :el-get hexmode/gnus-alias
    :config
    (setq gnus-alias-identity-alist
          '(("work"
             nil
             "中鉢欣秀 <yc@aiit.ac.jp>"
             nil ;; No organization header
             nil ;; No extra headers
             nil ;; No extra body text
             "~/.signature" ;; My signature
             ))))
#+end_src

#+RESULTS:
: gnus-alias

* OS依存の設定
** Linuxでmozcを使った日本語入力の設定（2021年版）
:PROPERTIES:
:BLOG:     plover
:DATE:     [2021-11-23 22:10:47]
:OPTIONS:  toc:nil num:nil todo:nil pri:nil tags:nil ^:nil
:CATEGORY: Tech
:POST_TAGS: Emacs, Lisp, Mozc, IME
:ID:       o2b:16b90138-c679-4ad8-b1f2-fab55daf0058
:POST_DATE: [2021-11-23 Tue 22:11]
:POSTID:   463
:END:

*** 説明
日本語入力周りの設定を見直してみました。

- 参考
  - [[https://w.atwiki.jp/ntemacs/pages/48.html][emacs-mozc を動かすための設定（Emacs 設定編） - NTEmacs @ ウィキ - atwiki（アットウィキ）]]

*** 全体の設定
Mozcに関連する設定の全体です。個別の説明は[[*Mozcサーバと通信するためのヘルパーコマンド][こちら]]から。

#+begin_src emacs-lisp :noweb yes
  (leaf mozc
    :if (eq system-type 'gnu/linux)
    :package t
    :config
    <<mozc-helper>>
    <<mozc-im>>
    <<mozc-im-state-isearch>>
    <<mozc-cursor-color>>
    <<mozc-posframe>>)
#+end_src

#+RESULTS:
: mozc

*** Mozcサーバと通信するためのヘルパーコマンド
Mozcとのやり取りをするためのヘルパーを設定します。
WSL環境では、mozc_emacs_helper.exeに置き換えると、Windows側のGoogle IMEが使えるはずです。

#+begin_comment
- [[https://qiita.com/ignorant/items/1c4f729f9147fb878f10][WSL の Emacs で日本語入力 - Qiita]]
  - Windows側のGoogle IMEを利用する
  - aptでインストールされたと思われるmozc_emacs_helper（バイナリ）を使ってみる。
    - 既に設定されていた
      [[https://github.com/smzht/mozc_emacs_helper][smzht/mozc_emacs_helper: mozc_emacs_helper for Windows]]
      これはUnix用

- Windows用のmozc_emacs_helper.exeを利用する
  - [[https://github.com/smzht/mozc_emacs_helper][smzht/mozc_emacs_helper: mozc_emacs_helper for Windows]]
    ここからmozc_emacs_helper.exeをダウンロードして
    ~/Dropbox/WSL/以下においておく

  - ~/bin/にmozc_emacs_helper_win.shを作成する

    #+begin_src bash :tangle no
      #!/bin/sh

      ~/Dropbox/WSL/mozc_emacs_helper.exe "$@" 2> /dev/null
    #+end_src
#+end_comment

#+NAME: mozc-helper
#+begin_src emacs-lisp :tangle no
  (if (getenv "WSLENV")
      ;; (setq mozc-helper-program-name "mozc_emacs_helper_win.sh")
      (setq mozc-helper-program-name "mozc_emacs_helper")
    (setq mozc-helper-program-name "mozc_emacs_helper"))
#+end_src

*** Mozcによる変換操作の設定
標準の入力方式をMozcに設定します。
C-oで変換モード、C-jで直接入力モードに切り替えます。

なお、org-modeでC-jを（特殊な？）改行コマンドとして使用しているので、leafのbind*でオーバライドします（便利！）。ちなみに、org-modeでの改行はC-mかRETでもできます。C-jの出番がどこにあるのか、わかりません。

デフォルトでは、IMの状態をトグルするメソッドしかないので、それぞれの状態に遷移するメソッドを用意します。

IMEがoffのとき、isearchに入り、IMEをonにして検索したあと、戻ったときにIMEがoffになって欲しいので、そのための設定をします（migemoを使うのなら、あまり必要ない設定かも）。

#+begin_comment
IME ON  -> isearch -> OFF -> done -> ON
IME ON  -> isearch -> ON  -> done -> ON
IME OFF -> isearch -> ON  -> done -> ON*
IME OFF -> isearch -> OFF -> done -> OFF
*のところで状態が狂う。
#+end_comment

#+NAME: mozc-im
#+begin_src emacs-lisp :tangle no :noweb yes
  (leaf mozc-im
    :ensure t
    :require t
    :custom ((default-input-method . "japanese-mozc-im"))
    :bind* (("C-o" . enable-input-method)
            ("C-j" . disable-input-method))
    :config
    (defvar-local mozc-im-mode nil)

    (add-hook 'mozc-im-activate-hook
              (lambda nil
                (setq mozc-im-mode t)))
    (add-hook 'mozc-im-deactivate-hook
              (lambda nil
                (setq mozc-im-mode nil)))

    (defun enable-input-method (&optional arg interactive)
      (interactive "P\np")
      (if (not current-input-method)
          (toggle-input-method arg interactive)))
    (defun disable-input-method (&optional arg interactive)
      (interactive "P\np")
      (if current-input-method
          (toggle-input-method arg interactive)))

    (add-hook 'isearch-mode-hook
              (lambda () (setq im-state mozc-im-mode)))
    (add-hook 'isearch-mode-end-hook
              (lambda ()
                (unless (eq im-state mozc-im-mode)
                  (if im-state
                      (activate-input-method default-input-method)
                    (deactivate-input-method))))))
#+end_src

#+RESULTS: mozc-im
: mozc-im

*** カーソルカラーを設定する
現在の状態に合わせて、カーソルの色を設定します。この設定では、直接入力の時はグレイ、変換モードのときは緑にしています。リードオンリーでは黄色になります。それ以外の状態は、私は使いませんが念の為。

なお、Emacsで使えるカラーの一覧は、M-x list-colors-displayで確認できます。

#+NAME: mozc-cursor-color
#+begin_src emacs-lisp :tangle no
  (leaf mozc-cursor-color
    :el-get iRi-E/mozc-el-extensions
    :require t
    :config
    (setq mozc-cursor-color-alist
          '((direct        . "gray")
            (read-only     . "yellow")
            (hiragana      . "green")
            (full-katakana . "goldenrod")
            (half-ascii    . "dark orchid")
            (full-ascii    . "orchid")
            (half-katakana . "dark goldenrod")))
    (advice-add 'mozc-cursor-color-update :around
                (lambda (orig-fun &rest args)
                  (let ((mozc-mode mozc-im-mode))
                    (apply orig-fun args)))))
#+end_src

#+RESULTS: mozc-cursor-color
: mozc-cursor-color

*** 変換候補をposframeで表示する

posframeはEmacs26から追加された機能です。Emacs26は3年ほど前にリリースされたようですから、私は長いことposframeを知らなかったことになります。

今回の設定変更の目玉商品です。「[[https://blog.deltabox.site/post/2019/06/mozc-posframe/][mozcの候補をposframeで表示するEmacs拡張を作った]]」に書いている通り、org-modeでの変換の際の表示崩れは目に余るものがありました。

作者さん、ありがとうございます。

#+NAME: mozc-posframe
#+begin_src emacs-lisp :tangle no
  (leaf mozc-posframe
    :straight (mozc-posframe :type git :host github :repo "derui/mozc-posframe")
    :config
    (mozc-posframe-register)
    (setq mozc-candidate-style 'posframe))
#+end_src

#+RESULTS: mozc-posframe
: mozc-posframe

** Windowsで文字のエンコードをUTF-8に
#+begin_src emacs-lisp
  (leaf windows
    :when (eq system-type 'windows-nt)
    :config
    (prefer-coding-system 'utf-8))
#+end_src

#+RESULTS:
: windows

** Windows IME設定
- [[https://nosubject.io/windows10-emacs-27-w32-ime/][[Emacs] Windows10 で Emacs 27 を使う | ** nosubject.io **]]
- [[https://qiita.com/tawara_/items/0a7b8c50a48ea86b2d91][あの IBM が作ったオープンソース日本語フォントを使い、プログラミングフォント『PlemolJP』を作ってみた - Qiita]]

  #+begin_src emacs-lisp
    (leaf tr-ime
      :when (eq system-type 'windows-nt)
      :ensure t
      :setq
      (default-input-method . "W32-IME")
      (w32-ime-mode-line-state-indicator-list . '("[--]" "[あ]" "[--]"))
      :setq-default
      (w32-ime-mode-line-state-indicator . "[--]")
      :config
      (tr-ime-standard-install)
      (w32-ime-initialize)
      ;; IME制御（yes/noなどの入力時にIMEをoffにする
      (wrap-function-to-control-ime 'universal-argument t nil)
      (wrap-function-to-control-ime 'read-string nil nil)
      (wrap-function-to-control-ime 'read-char nil nil)
      (wrap-function-to-control-ime 'read-from-minibuffer nil nil)
      (wrap-function-to-control-ime 'y-or-n-p nil nil)
      (wrap-function-to-control-ime 'yes-or-no-p nil nil)
      (wrap-function-to-control-ime 'map-y-or-n-p nil nil)
      ;; 通常使用するフォント
      ;; (set-frame-font "BIZ UDゴシック-12" nil t)
      (set-frame-font "PlemolJP-12" nil t)
      (setq-default line-spacing 0) ; 行間
      ;; IME未確定時のフォント設定
      (modify-all-frames-parameters '((ime-font . "PlemolJP-12")))
      :bind
      ("C-o" . toggle-input-method))
  #+end_src

  #+RESULTS:
  : tr-ime

  #+begin_src emacs-lisp
    (when (eq system-type 'windows-nt)
      (package-install 'tr-ime)
      (tr-ime-standard-install)
      (setq default-input-method "W32-IME")
      (w32-ime-initialize))
  #+end_src

** WSLでWindows側のブラウザを立ち上げる

- WSL側からWindowsを制御するユーテリティ
  - [[https://github.com/wslutilities/wslu][wslutilities/wslu: A collection of utilities for Windows 10 Linux Subsystems]]
  - wslviewコマンドを利用する

- Emacsが使うブラウザを設定する
  - [[https://www.emacswiki.org/emacs/BrowseUrl#h5o-4][[Home] Browse Url]]

- WSLかどうか判断
  - [[https://qiita.com/miy4/items/acf50a9c0a053b878b56#%E7%92%B0%E5%A2%83%E5%A4%89%E6%95%B0%E3%82%92%E6%8E%A2%E3%81%99][EmacsでWSLを使っている/いないを判断する - Qiita]]

[[help:browse-url-browser-function’s]]

#+begin_src emacs-lisp
  (when (and (eq system-type 'gnu/linux)
             (getenv "WSLENV"))
    (setq browse-url-browser-function 'my/browser)
    (setq browse-url-generic-program "web-browser"))

  (defun my/browser (url &rest ignore)
    "Browse URL using wslview."
    (interactive "sURL: ")
    (shell-command (concat "wslview " "'" url "'")))
#+end_src

#+RESULTS:
: my/browser

* 未整理
** EAF - Emacs Application Framework
+ .emacs.dをgitで管理しているのでsubmoduleで追加
+ install-eaf.py を実行する前に apt update && apt upgrade

#+begin_src emacs-lisp :tangle no
  (leaf eaf
    :load-path "~/.emacs.d/site-lisp/emacs-application-framework" ; Set to "/usr/share/emacs/site-lisp/eaf" if installed from AUR
    :require t
    :custom ; See https://github.com/emacs-eaf/emacs-application-framework/wiki/Customization
    (eaf-browser-continue-where-left-off . t)
    (eaf-browser-enable-adblocker . t)
    (browse-url-browser-function . 'eaf-open-browser)
    :config
    (require 'eaf-browser)
    (require 'eaf-pdf-viewer)

    (defalias 'browse-web #'eaf-open-browser)
    (eaf-bind-key scroll_up "C-n" eaf-pdf-viewer-keybinding)
    (eaf-bind-key scroll_down "C-p" eaf-pdf-viewer-keybinding)
    ;; (eaf-bind-key take_photo "p" eaf-camera-keybinding)
    (eaf-bind-key nil "M-q" eaf-browser-keybinding)) ;; unbind, see more in the Wiki
#+end_src

#+RESULTS:
: eaf
** project.el
+ 説明
  * プロジェクトを扱う

+ 設定

  #+begin_src emacs-lisp :tangle no
    (leaf project :package t :require t)
  #+end_src

  #+RESULTS:
  : project

** hydra

+ [[https://medium.com/@mopemope/hydra-%E3%81%AE%E3%82%B9%E3%82%B9%E3%83%A1-88a4168f945c][Hydra のススメ. みなさん、 Emacs 使ってますか？先日 Emacs 26.1… | by mopemope | Medium]]

#+begin_src emacs-lisp
(defhydra hydra-zoom (global-map "<f2>")
  "zoom"
  ("g" text-scale-increase "in")
  ("l" text-scale-decrease "out"))
#+end_src

#+RESULTS:
: hydra-zoom/body

* おわりに
** お約束の記述

#+begin_src emacs-lisp
(provide 'README)

;; Local Variables:
;; indent-tabs-mode: nil
;; byte-compile-warnings: (not cl-functions obsolete)
;; End:

;;; README.el ends here
#+end_src

** 参考文献
1. [[https://uwabami.github.io/cc-env/Emacs.html][Emacs の設定 | Youhei SASAKI’s official site]]
* TODO [#C] Emacs設定のアイデア [18/22]                              :REFILE:
- [ ] embarkでGoogle検索
- [ ] emacs の org-mode と google calendar を連携させる org-gcal - Qiita
  SCHEDULED: [2021-11-18 Thu]
  :PROPERTIES:
  :CREATED:  [2021-11-18 Thu 02:20]
  :END:

  https://qiita.com/clothoid/items/73a937a22eeeb82c3ee7
- [ ] flymakeでスペルチェック
  :PROPERTIES:
  :CREATED: <2021-11-13 Sat 11:05>
  :ANNOTADED:
  :END:
- [X] [[https://qiita.com/Ladicle/items/feb5f9dce9adf89652cf#%E5%B0%8F%E6%8C%87%E3%82%92%E9%85%B7%E4%BD%BF%E3%81%9B%E3%81%9A%E3%81%8B%E3%81%A4%E3%82%AD%E3%83%BC%E3%83%90%E3%82%A4%E3%83%B3%E3%83%89%E3%81%AE%E3%82%AC%E3%82%A4%E3%83%89%E3%82%92%E5%87%BA%E3%81%99----hydra][Emacsモダン化計画 -かわEmacs編- - Qiita]]
- [ ] 偉人 アーサー・Ｃ・クラーク　名言集(英訳付)｜心の常備薬
   :PROPERTIES:
   :CREATED:  [2021-10-16 Sat 12:45]
   :END:

 http://medicines.aquaorbis.net/meigen/kaigai/bungaku-e/arthur-c-clarke
- [X] org2blogでソースコードのショートコード、開始側がでない？
- [X] リアルオートセーブアップ
  :PROPERTIES:
:CREATED: <2021-11-10 Wed 09:47>
:ANNOTADED: [[file:~/.emacs.d/README.org::*leaf][leaf]]
:END:
  - [[http://emacs.rubikitch.com/backup-each-save/][backup-each-save.el : Emacs式大富豪的バックアップ！保存する度に日時付きファイルでバックアップ]]
  - [[http://emacs.rubikitch.com/real-auto-save/][real-auto-save.el : バッファを自動保存させる超シンプルなマイナーモード]]
- [X] org-publishを使ってorgでブログを書く話 - Qiita
  :PROPERTIES:
  :CREATED:  [2021-11-18 Thu 03:05]
  :END:

  https://qiita.com/conao3/items/f81cf964198d4da93a05
- [X] org-gfmを導入する
  :PROPERTIES:
:CREATED: <2021-11-12 Fri 10:30>
:ANNOTADED:
:END:
  必要になったらやろう
- [X] Emacs の org-mode でスケジュール管理をしよう！ - Qiita
  SCHEDULED: [2021-11-18 Thu]
  :PROPERTIES:
  :CREATED:  [2021-11-18 Thu 02:19]
  :END:

  https://qiita.com/zonkyy/items/821ea2b1e20f575c222f
- [X] notmuchでメール中のURLがEnterでは開けない
  :PROPERTIES:
:CREATED:  <2021-11-17 Wed 18:07>
:ANNOTADED: [[notmuch:id:001001d7db84$acfb8610$06f29230$@brain.riken.jp][Email from hkimura@brain.riken.jp: [sys_education:00683] Re: 第２２回SIC人財育成協議会の日程調整]]
:END:
- [X] fniessen/org-html-themes: How to export Org mode files into awesome HTML in 2 minutes
  :PROPERTIES:
  :CREATED:  [2021-11-18 Thu 19:14]
  :END:

  https://github.com/fniessen/org-html-themes
- [X] org-tree-slideでプレゼン
   :PROPERTIES:
   :CREATED:  [2021-09-29 Wed 12:24]
   :END:
   対象者がエンジニアだけならよいかも
   https://github.com/daviwil/emacs-from-scratch/blob/master/show-notes/Emacs-Tips-04.org
- [X] Org-roam事始め - Qiita
   :PROPERTIES:
   :CREATED:  [2021-10-16 Sat 02:30]
   :END:
    https://qiita.com/unsignedint/items/749dd5e87bcadf13e3a6

   まだいまいち必要性がわからない
   なるべく少ないファイルにまとめたほうがよいように思う
- [X] Emacs のテーマを変更 | 二代目俺のメモ
   :PROPERTIES:
   :CREATED:  [2021-10-16 Sat 18:53]
   :END:

   https://www.kwonline.org/memo2/2020/06/14/load-themes-on-emacs-24/
- [X] Emacs の設定 | Youhei SASAKI’s official site
   CLOSED: [2021-11-09 Tue 09:25]
   :PROPERTIES:
   :CREATED:  [2021-10-25 Mon 18:37]
   :END:
  https://uwabami.github.io/cc-env/Emacs.html
- [X] emacs-eaf/emacs-application-framework: A free/libre and open-source extensible framework that revolutionizes the graphical capabilities of Emacs, the key to ultimately Live in Emacs
   CLOSED: [2021-11-09 Tue 09:25]
   :PROPERTIES:
   :CREATED:  [2021-10-26 Tue 10:26]
   :END:

    https://github.com/emacs-eaf/emacs-application-framework
- [X] SOMEDAY [Home] unbound.el
   :PROPERTIES:
   :CREATED:  [2021-11-09 Tue 03:17]
   :END:
   キーバインドの空きを探すスクリプトのようだ。

   https://www.emacswiki.org/emacs/unbound.el
- [X] kawabata/ox-pandoc: Another org-mode exporter via pandoc.
  :PROPERTIES:
  :CREATED:  [2021-11-12 Fri 18:23]
  :END:

  https://github.com/kawabata/ox-pandoc
- [X] SOMEDAY Emacsの中で動く作図ツールを作る | Misohena Blog
   :PROPERTIES:
   :CREATED:  [2021-09-22 Wed 14:54]
   :END:
   http://misohena.jp/blog/2021-09-21-emacs-easy-draw.html

  - [[https://github.com/misohena/el-easydraw][GitHub - misohena/el-easydraw: Embedded drawing tool for Emacs]]
  - バイトコンパイルでエラー

  #+begin_src emacs-lisp :tangle no
  (leaf edraw-org
    :el-get misohena/el-easydraw
    :require t
    :after org
    :config
    (edraw-org-setup-default))
  #+end_src

  #+RESULTS:
  : edraw-org

   試してみたけど動かなかった
- [X] org-mode をマイナーモードとして使う orgstruct-mode。 - 日々、とんは語る。
  :PROPERTIES:
  :CREATED:  [2021-11-17 Wed 21:50]
  :END:

  https://tomoya.hatenadiary.org/entry/20090414/1239697066
  orgstruct-modeは古い
- [X] TABバー
   CLOSED: [2021-11-09 Tue 09:24]
   :PROPERTIES:
   :CREATED:  [2021-11-03 Wed 18:03]
   :END:

 https://github.com/daviwil/emacs-from-scratch/blob/82f03806d90eb356b815cf514d10b6d863a2cbdc/show-notes/Emacs-Tips-06.org
